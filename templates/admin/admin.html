<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración - Loansi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/components.css" rel="stylesheet">

        <!--  HELPER CSRF PARA TODAS LAS PETICIONES -->
    <script>
    function getCSRFToken() {
        var tokenInput = document.querySelector('input[name="csrf_token"]');
        if (tokenInput) {
            return tokenInput.value;
        }

        // Backup: buscar en cualquier formulario
        var allTokens = document.querySelectorAll('input[name="csrf_token"]');
        if (allTokens.length > 0) {
            return allTokens[0].value;
        }

        console.error('❌ No se encontró token CSRF');
        return '';
    }
    </script>

    <!-- contraste en inputs (especialmente "Tasa nominal mensual") -->
    <style>
      /* Tema oscuro: campos legibles */
      [data-theme="dark"] .form-control{
        background-color:#2b3442 !important;
        color:#f2f4f8 !important;
        border-color:#3b4658 !important;
      }
      [data-theme="dark"] .input-group-text{
        background-color:#1f2633 !important;
        color:#d7e3ff !important;
        border-color:#3b4658 !important;
      }
      [data-theme="dark"] #TasasCredito .card .form-control,
      [data-theme="dark"] #TasasCredito .card .input-group .form-control,
      [data-theme="dark"] #TasasCredito input[type="text"],
      [data-theme="dark"] #TasasCredito input[readonly],
      [data-theme="dark"] #TasasCredito input:read-only,
      [data-theme="dark"] #TasasCredito input:disabled {
        background-color:#1f2937 !important;     /* slate-800 */
        color:#e5e7eb !important;                 /* texto claro */
        border-color:#374151 !important;          /* slate-700 */
        -webkit-text-fill-color:#e5e7eb !important; /* forzar color en inputs readonly/disabled (WebKit) */
      }

      /* Addon % y $ dentro de input-group */
      [data-theme="dark"] #TasasCredito .input-group-text{
        background-color:#111827 !important;      /* slate-900 */
        color:#d1d5db !important;                  /* gris claro */
        border-color:#374151 !important;
      }

      /* Si alguna clase fuerza blanco por Bootstrap/utilidades */
      [data-theme="dark"] #TasasCredito .bg-white,
      [data-theme="dark"] #TasasCredito .bg-light,
      [data-theme="dark"] #TasasCredito .bg-body,
      [data-theme="dark"] #TasasCredito .bg-body-tertiary{
        background-color:#1f2937 !important;
        color:#e5e7eb !important;
        border-color:#374151 !important;
      }

      /* Placeholders más tenues en oscuro */
      [data-theme="dark"] #TasasCredito .form-control::placeholder{
        color:#9ca3af !important;                  /* gray-400 */
        opacity:1 !important;
      }

        /* ========================================
         DRAG & DROP CRITERIOS MEJORADO (2025-12-26)
         ======================================== */
      .scoring-criteria-row {
        transition: all 0.2s ease;
        border: 2px solid transparent;
        border-radius: 8px;
        background: var(--bs-body-bg);
        touch-action: none;
        position: relative;
      }

      .scoring-criteria-row.dragging {
        opacity: 0.4 !important;
        border: 2px dashed var(--bs-primary) !important;
        background: rgba(var(--bs-primary-rgb), 0.05);
      }

      .scoring-criteria-row.drag-over {
        border: 2px solid var(--bs-primary) !important;
        background-color: rgba(13, 110, 253, 0.1) !important;
        transform: scale(1.01);
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.3);
      }

      [data-theme="dark"] .scoring-criteria-row.drag-over {
        background-color: rgba(13, 110, 253, 0.2) !important;
      }

      .drag-handle {
        color: var(--bs-secondary);
        transition: all 0.2s;
        cursor: grab;
        padding: 4px 8px;
        border-radius: 4px;
        user-select: none;
        -webkit-user-select: none;
        touch-action: none;
      }

      .drag-handle:hover {
        color: var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.1);
      }

      .drag-handle:active {
        cursor: grabbing;
        color: var(--bs-primary);
      }

      .scoring-criteria-row:hover .drag-handle {
        color: var(--bs-primary);
      }

      /* ========================================
         SECCIONES DE CRITERIOS (2025-12-26)
         ======================================== */
      .criterios-seccion {
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        background: var(--bs-body-bg);
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .criterios-seccion.dragging {
        opacity: 0.5;
        border: 2px dashed var(--bs-primary);
      }

      .criterios-seccion.drag-over-seccion {
        border: 2px solid var(--bs-success) !important;
        box-shadow: 0 0 15px rgba(25, 135, 84, 0.3);
      }

      .criterios-seccion-header {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: grab;
        color: white;
        font-weight: 600;
      }

      .criterios-seccion-header:active {
        cursor: grabbing;
      }

      .criterios-seccion-header h5 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .criterios-seccion-header .seccion-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .criterios-seccion-header .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }

      .criterios-seccion-body {
        padding: 1rem;
        min-height: 50px;
      }

      .criterios-seccion-body.drag-over {
        background-color: rgba(13, 110, 253, 0.05);
      }

      .criterios-seccion.collapsed .criterios-seccion-body {
        display: none;
      }

      /* Badge contador de criterios por sección  */
      .seccion-count-badge {
        background-color: rgba(255, 255, 255, 0.9) !important;
        color: #1f2937 !important;
        font-weight: 600;
        min-width: 24px;
        text-align: center;
      }

      [data-theme="dark"] .seccion-count-badge {
        background-color: rgba(255, 255, 255, 0.15) !important;
        color: #ffffff !important;
      }

      .criterios-seccion-empty {
        text-align: center;
        padding: 2rem;
        color: var(--bs-secondary);
        font-style: italic;
        pointer-events: none; /* 2025-12-26: Permitir que eventos de drop pasen al contenedor padre */
      }

      /* Sin sección - Otros criterios */
      .criterios-sin-seccion {
        border: 1px dashed var(--bs-border-color);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        background: rgba(var(--bs-secondary-rgb), 0.05);
      }

      .criterios-sin-seccion-title {
        color: var(--bs-secondary);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* Colores de secciones */
      .seccion-color-purple { background: linear-gradient(135deg, #6f42c1 0%, #8b5cf6 100%); }
      .seccion-color-blue { background: linear-gradient(135deg, #0d6efd 0%, #3b82f6 100%); }
      .seccion-color-green { background: linear-gradient(135deg, #198754 0%, #22c55e 100%); }
      .seccion-color-orange { background: linear-gradient(135deg, #fd7e14 0%, #f97316 100%); }
      .seccion-color-red { background: linear-gradient(135deg, #dc3545 0%, #ef4444 100%); }
      .seccion-color-teal { background: linear-gradient(135deg, #20c997 0%, #14b8a6 100%); }
      .seccion-color-gray { background: linear-gradient(135deg, #6c757d 0%, #71717a 100%); }

      /* Badge de sección en criterio */
      .criterio-seccion-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 0.5rem;
      }

      /* Modal de sección */
      .color-picker-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
      }

      .color-picker-item {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s;
      }

      .color-picker-item:hover {
        transform: scale(1.1);
      }

      .color-picker-item.selected {
        border-color: var(--bs-dark);
        box-shadow: 0 0 0 2px white, 0 0 0 4px var(--bs-primary);
      }

      /* Indicador de drop en sección */
      .criterios-seccion-body.accepting-drop::before {
        content: 'Soltar criterio aquí';
        display: block;
        text-align: center;
        padding: 1rem;
        background: rgba(13, 110, 253, 0.1);
        border: 2px dashed var(--bs-primary);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        color: var(--bs-primary);
        font-weight: 500;
      }

      /* Color purple para badges de rol supervisor */
      .bg-purple {
        background-color: #6f42c1 !important;
        color: white !important;
      }
    </style>

    <style>
/* ========================================
   CONTRASTE SCORING TEMA OSCURO
   ======================================== */

/* Tarjetas de criterios en tema oscuro */
[data-theme="dark"] .scoring-criteria-row {
    background-color: #1f2937 !important;
    border: 1px solid #374151 !important;
}

/* Nombres de criterios SIEMPRE visibles */
[data-theme="dark"] .scoring-criteria-row h6,
[data-theme="dark"] .scoring-criteria-row .mb-0 {
    color: #f7fafc !important;
    font-weight: 600 !important;
}

/* Badge de peso visible */
[data-theme="dark"] .badge-peso {
    background-color: #7c8cfc !important;
    color: white !important;
}

/* Descripción de rangos */
[data-theme="dark"] .scoring-criteria-row .small,
[data-theme="dark"] .scoring-criteria-row .text-muted {
    color: #9ca3af !important;
}

/* Tabla de rangos en tema oscuro */
[data-theme="dark"] .scoring-criteria-row .table {
    background-color: #111827 !important;
}

[data-theme="dark"] .scoring-criteria-row .table thead {
    background: linear-gradient(135deg, #7c8cfc 0%, #667eea 100%) !important;
}

[data-theme="dark"] .scoring-criteria-row .table thead th {
    color: white !important;
}

[data-theme="dark"] .scoring-criteria-row .table tbody td {
    background-color: #1f2937 !important;
    color: #e5e7eb !important;
    border-color: #374151 !important;
}

/* Sección de scoring general */
[data-theme="dark"] .scoring-section {
    background-color: #1f2937 !important;
    border-color: #4a5568 !important;
}

[data-theme="dark"] .scoring-header h5 {
    color: #f7fafc !important;
}

/* Botones en scoring oscuro */
[data-theme="dark"] .scoring-criteria-row .btn-outline-primary {
    color: #7c8cfc !important;
    border-color: #7c8cfc !important;
}

[data-theme="dark"] .scoring-criteria-row .btn-outline-primary:hover {
    background-color: #7c8cfc !important;
    color: white !important;
}

[data-theme="dark"] .scoring-criteria-row .btn-outline-danger {
    color: #fc8181 !important;
    border-color: #fc8181 !important;
}

[data-theme="dark"] .scoring-criteria-row .btn-outline-success {
    color: #68d391 !important;
    border-color: #68d391 !important;
}

/* Range rows (filas de rangos) */
[data-theme="dark"] .range-row {
    background-color: #111827 !important;
    border: 1px solid #374151 !important;
}
        .tab {

            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-weight: bold;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #0d6efd;
            color: white;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 10px;
            /* ✅ CRITICAL: Asegurar que cuando se active, sea visible */
            min-height: 200px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .tabcontent.active,
        .tabcontent[style*="display: block"] {
            visibility: visible !important;
            opacity: 1 !important;
        }

        #Usuarios { display: block; }

        /* Estilos para secciones de scoring */
        .scoring-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .scoring-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .scoring-criteria-row {
            background-color: #fff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .range-row {
            background-color: #f1f4f7;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .badge-peso {
            background-color: #0d6efd;
            color: white;
            padding: 3px 7px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: normal;
        }

        /* Estilos para niveles de riesgo */
        .nivel-riesgo-card {
            border-radius: 8px;
            margin-bottom: 10px;
            color: white;
            padding: 10px;
        }

                /* Estilos para las tasas */
        .tasas-box {
            background-color: #f0f8ff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #0d6efd;
        }

        /* Pastilla donde se muestra la tasa mensual (CLARO) */
        .tasa-mensual {
            background-color: #e8f4ff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #0d6efd;
            font-weight: bold;
        }

        /* --- Overrides para TEMA OSCURO --- */
        /* Caja de tasas en oscuro */
        [data-theme="dark"] #TasasCredito .tasas-box {
            background-color: #111827;            /* slate-900 */
            border-left-color: #60a5fa;           /* azul accesible */
        }

        /* Pastilla con el valor calculado en oscuro (texto SIEMPRE visible) */
        [data-theme="dark"] #TasasCredito .tasa-mensual {
            background-color: #1f2937 !important; /* slate-800 */
            color: #e5e7eb !important;            /* texto claro */
            border: 1px solid #374151;            /* slate-700 */
            box-shadow: none !important;
        }

        /* Evitar que utilitarios .bg-* o .text-* sobreescriban en oscuro */
        [data-theme="dark"] #TasasCredito .tasa-mensual span,
        [data-theme="dark"] #TasasCredito .tasa-mensual .text-muted {
            color: #e5e7eb !important;
        }

        @media (max-width: 768px) {
            .tab button {
                padding: 10px 12px;
                font-size: 14px;
                width: 100%;
            }

            .tab {
                display: flex;
                flex-direction: column;
            }

            .tabcontent {
                padding: 15px;
            }

            .container {
                padding: 10px;
            }

            .card-body {
                padding: 15px;
            }

            .table {
                font-size: 14px;
            }

            .table td, .table th {
                padding: 0.5rem;
            }

            .d-flex {
                flex-direction: column;
            }

            .d-flex .badge, .d-flex .btn {
                margin-bottom: 5px;
            }
        }
        /* Header perfectamente alineado - solución definitiva para admin panel */
        .admin-header-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: flex-end;
            width: 100%;
        }

        .admin-user-badge {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .admin-action-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-btn {
            height: 38px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.75rem;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 0.375rem;
            white-space: nowrap;
            transition: all 0.2s ease;
            text-decoration: none;
            border: 1px solid;
            min-width: auto;
            vertical-align: middle;
        }

        .admin-btn i {
            font-size: 16px;
            margin-right: 0.375rem;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Estilo específico para el botón de tema */
        #theme-toggle {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #495057;
        }

        #theme-toggle:hover {
            background-color: #e2e6ea;
            border-color: #dae0e5;
            color: #495057;
        }

        #theme-toggle .theme-text {
            margin-left: 0.25rem;
        }

        /* Modo oscuro para el botón de tema */
        [data-theme="dark"] #theme-toggle {
            background-color: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] #theme-toggle:hover {
            background-color: var(--bg-secondary);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* Responsive para pantallas medianas */
        @media (max-width: 992px) {
            .admin-header-container {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }

            .admin-user-badge {
                text-align: center;
                margin-bottom: 0.5rem;
            }

            .admin-action-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }

            .admin-btn {
                flex: 1;
                min-width: 140px;
            }
        }

        /* Responsive para pantallas pequeñas */
        @media (max-width: 768px) {
            .admin-header-container {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .admin-action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .admin-btn {
                width: 100%;
                justify-content: center;
            }

            #theme-toggle .theme-text {
                display: inline;
            }
        }

        /* Responsive para móviles */
        @media (max-width: 576px) {
            .admin-btn {
                font-size: 13px;
                padding: 0.5rem 0.75rem;
                height: 40px;
            }

            .admin-btn i {
                font-size: 18px;
            }

            #theme-toggle .theme-text {
                display: none;
            }
        }
        /* Compatibilidad cross-browser */
        .admin-action-buttons {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
        }

        .admin-btn {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Fix para Firefox */
        @-moz-document url-prefix() {
            .admin-btn {
                line-height: 36px;
            }
        }

        /* Fix para Safari */
        @supports (-webkit-appearance: none) {
            .admin-btn {
                -webkit-box-align: center;
                display: -webkit-inline-flex;
            }
        }

        /* Mejoras visuales para panel admin */
        .container {
            max-width: 1400px;
            animation: fadeIn 0.5s ease-out;
        }

        .tab {
            background: transparent;
            border: none;
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .tab button {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px 12px 0 0;
            padding: 14px 24px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            position: relative;
        }

        .tab button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .tab button:hover {
            background: var(--bg-secondary);
            color: var(--primary);
        }

        .tab button.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: var(--primary);
        }

        .tab button.active::after {
            width: 100%;
        }

        .tabcontent {
            background: var(--bg-card);
            border-radius: 0 12px 12px 12px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease-out;
        }

        .card {
            transition: all 0.3s ease;
            border-radius: 16px;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .table {
            border-radius: 12px;
            overflow: hidden;
        }

        .modal-content {
            border-radius: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        /* Dashboard stats cards */
        .stats-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="row mb-4">
    <div class="col">
        <h2>Panel de Administración Loansi</h2>
        <p>Gestiona usuarios, costos, tasas de interés y parámetros del sistema</p>
    </div>
    <div class="col-auto">
        <div class="admin-header-container">
            <div class="admin-user-info" style="display: flex; align-items: center; gap: 10px; padding: 8px 14px; background: var(--bg-secondary, #f8f9fa); border-radius: 10px; border: 1px solid var(--border-color, #dee2e6);">
                <i class="bi bi-person-circle" style="font-size: 1.4rem; color: var(--primary, #667eea);"></i>
                <div style="line-height: 1.3;">
                    <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-primary, #1a202c); display: block;">
                        {{ session.get('nombre_completo') or session.get('username') }}
                    </span>
                    <span style="font-size: 0.75rem; color: var(--text-muted, #6c757d);">
                        {% if session.get('nombre_completo') %}@{{ session.get('username') }} · {% endif %}
                        <span class="badge bg-danger" style="font-size: 0.65rem; padding: 2px 6px;">ADMIN</span>
                    </span>
                </div>
            </div>
            <div class="admin-action-buttons" role="group" aria-label="Acciones del usuario">
                <a href="/simulador"
                   class="btn btn-outline-primary admin-btn"
                   target="_blank">
                   <i class="bi bi-calculator"></i> Ir al Simulador
                </a>
                <button id="theme-toggle"
                        class="btn btn-outline-secondary admin-btn"
                        type="button"
                        aria-label="Cambiar tema"
                        title="Cambiar tema">
                    <i class="bi bi-moon-fill"></i>
                    <span class="theme-text">Tema</span>
                </button>
                <a href="/logout"
                   class="btn btn-outline-danger admin-btn">
                   <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                </a>
            </div>
        </div>
    </div>
</div>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert alert-info alert-dismissible fade show">
        {% for message in messages %}
            {{ message }}<br>
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% endwith %}

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'Usuarios')" id="defaultOpen">Usuarios</button>
        <button class="tablinks" onclick="openTab(event, 'TasasCredito')">Tasas de Crédito</button>
        <button class="tablinks" onclick="openTab(event, 'CostosAsociados')">Costos Asociados</button>
        <button class="tablinks" onclick="openTab(event, 'Seguros')">Seguros</button>
        <button class="tablinks" onclick="openTab(event, 'Scoring')">Scoring Interno</button>
        <button class="tablinks" onclick="openTab(event, 'CapacidadPago')">Capacidad de Pago</button>
        <button class="tablinks" onclick="window.location.href='/admin/comite-credito'" style="background-color: rgba(255, 193, 7, 0.2); border-left: 3px solid #ffc107;">
            <i class="bi bi-people-fill me-1"></i>Comité de Crédito
        </button>
        <button class="tablinks" onclick="window.location.href='/admin/historial-evaluaciones'">
            <i class="bi bi-clock-history me-1"></i>Historial Completo
        </button>
        {% if tiene_permiso('usr_permisos') %}
        <button class="tablinks" onclick="openTab(event, 'Permisos')" style="background-color: rgba(138, 43, 226, 0.15); border-left: 3px solid #8a2be2;">
            <i class="bi bi-shield-lock me-1"></i>Permisos
        </button>
        {% endif %}
    </div>

    <!-- Pestaña de Usuarios -->
    <div id="Usuarios" class="tabcontent">
        <h4 class="mb-4">Gestión de Usuarios</h4>

        {% if tiene_alguno_de(['usr_permisos', 'usr_asignaciones_equipo']) %}
        <!-- Asignaciones de Equipo - Solo con permiso -->
        <a href="{{ url_for('admin_asignaciones_equipo') }}" class="btn btn-outline-info mb-3">
            <i class="bi bi-people-fill me-1"></i>Asignaciones de Equipo
        </a>
        {% endif %}

        <div class="row mb-4">
            {% if tiene_permiso('usr_ver') %}
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Usuarios Existentes</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Nombre Completo</th>
                                        <th>Rol</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for username, user_data in usuarios.items() %}
                                    <tr>
                                        <td><code>{{ username }}</code></td>
                                        <td>{{ user_data.nombre_completo or '-' }}</td>
                                        <td>
                                            <span class="badge
                                                {% if user_data.rol == 'admin' %}bg-danger
                                                {% elif user_data.rol == 'supervisor' %}bg-purple
                                                {% elif user_data.rol == 'auditor' %}bg-warning text-dark
                                                {% elif user_data.rol == 'gerente' %}bg-success
                                                {% elif user_data.rol == 'admin_tecnico' %}bg-info
                                                {% elif user_data.rol == 'comite_credito' %}bg-dark
                                                {% else %}bg-primary{% endif %}">
                                                {{ user_data.rol|upper|replace('_', ' ') }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if tiene_permiso('usr_password') %}
                                            <button type="button" class="btn btn-sm btn-warning"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#cambiarPasswordModal"
                                                    data-username="{{ username }}">
                                                Cambiar Contraseña
                                            </button>
                                            {% endif %}
                                            {% if username != "admin" and tiene_permiso('usr_eliminar') %}
                                            <form method="post" action="/admin/usuario/eliminar" class="d-inline"
                                                  onsubmit="return confirm('¿Estás seguro de eliminar este usuario?');">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <input type="hidden" name="username" value="{{ username }}">
                                                <input type="hidden" name="current_tab" value="Usuarios">
                                                <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if tiene_permiso('usr_crear') %}
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Crear Nuevo Usuario</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="/admin/usuario/nuevo">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="current_tab" value="Usuarios">

                            <div class="mb-3">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" name="nombre_completo" class="form-control"
                                       placeholder="Ej: Juan Pérez García" required>
                                <div class="form-text">Nombre que se mostrará en la interfaz</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nombre de Usuario</label>
                                <input type="text" name="username" class="form-control"
                                       placeholder="Ej: jperez" required>
                                <div class="form-text">Para iniciar sesión (sin espacios)</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Contraseña</label>
                                <input type="password" name="password" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Rol</label>
                                <select name="rol" class="form-select" required>
                                    <option value="asesor">Asesor</option>
                                    <option value="supervisor">Supervisor</option>
                                    <option value="auditor">Auditor</option>
                                    <option value="gerente">Gerente</option>
                                    <option value="admin_tecnico">Admin Técnico</option>
                                    <option value="comite_credito">Comité de Crédito</option>
                                    <option value="admin">Administrador (Super)</option>
                                </select>
                                <div class="form-text">Cada rol tiene permisos predefinidos que se pueden personalizar</div>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-plus me-2"></i>Crear Usuario
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        {% if not tiene_permiso('usr_ver') and not tiene_permiso('usr_crear') %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No tienes permisos para gestionar usuarios.
        </div>
        {% endif %}
    </div>

    <!-- Pestaña de Tasas de Crédito -->
<div id="TasasCredito" class="tabcontent">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">Gestión de Tasas de Interés</h4>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevaLineaCreditoModal">
            <i class="bi bi-plus-circle me-2"></i>Nueva Línea de Crédito
        </button>
    </div>

    <div class="row">
        {% for tipo_credito, datos in lineas_credito.items() %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ tipo_credito }}</h5>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="editarLineaCredito('{{ tipo_credito }}')">
                                <i class="bi bi-pencil me-2"></i>Editar Línea
                            </a></li>
                            {% if lineas_credito|length > 1 %}
                            <li><a class="dropdown-item text-danger" href="#" onclick="eliminarLineaCredito('{{ tipo_credito }}')">
                                <i class="bi bi-trash me-2"></i>Eliminar Línea
                            </a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" action="/admin/lineas">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="tipo_credito" value="{{ tipo_credito }}">
                        <input type="hidden" name="current_tab" value="TasasCredito">

                        <!-- Información básica de la línea -->
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <input type="text" class="form-control form-control-sm"
                                   value="{{ datos.descripcion }}" readonly>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Monto Mínimo</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control"
                                               value="{{ '{:,.0f}'.format(datos.monto_min).replace(',', '.') }}" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Monto Máximo</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control"
                                               value="{{ '{:,.0f}'.format(datos.monto_max).replace(',', '.') }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Plazo Mínimo</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control"
                                               value="{{ datos.plazo_min }}" readonly>
                                        <span class="input-group-text">{{ datos.plazo_tipo }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label">Plazo Máximo</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control"
                                               value="{{ datos.plazo_max }}" readonly>
                                        <span class="input-group-text">{{ datos.plazo_tipo }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Configuración de desembolso -->
                        <div class="row mt-2 mb-3">
                            <div class="col-12">
                                <label class="form-label">Modalidad de Desembolso</label>
                                <div>
                                    {% if datos.get('permite_desembolso_neto', False) %}
                                        <span class="badge bg-success me-2">
                                            <i class="bi bi-check-circle me-1"></i>Permite desembolso neto
                                        </span>
                                        <span class="badge bg-info">
                                            Por defecto: {{ 'Completo' if datos.get('desembolso_por_defecto', 'completo') == 'completo' else 'Neto' }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle me-1"></i>Solo desembolso completo
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Sección de tasas para admin.html -->
                        <div class="tasas-box">
                            <div class="mb-3">
                                <label class="form-label">Tasa Efectiva Anual (E.A.)</label>
                                <div class="input-group">
                                    <input type="text"
                                           id="tasa_anual_{{ tipo_credito }}"
                                           name="tasa_anual"
                                           value="{{ datos.tasa_anual }}"
                                           class="form-control"
                                           oninput="actualizarTasaMensual('tasa_anual_{{ tipo_credito }}', 'tasa_mensual_{{ tipo_credito }}')">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="form-label d-block">Tasa Nominal Mensual (calculada automáticamente)</label>
                                <div class="tasa-mensual">
                                    <span id="tasa_mensual_{{ tipo_credito }}">{{ datos.tasa_mensual }}%</span>
                                </div>
                                <small class="text-muted">Esta tasa se calcula automáticamente y será la que se aplique a las simulaciones</small>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para Nueva Línea de Crédito -->
<div class="modal fade" id="nuevaLineaCreditoModal" tabindex="-1" aria-labelledby="nuevaLineaCreditoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaLineaCreditoModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Crear Nueva Línea de Crédito
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formNuevaLinea" method="post" action="/admin/lineas/nueva">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Nota:</strong> Al crear una nueva línea de crédito, se configurará automáticamente en todas las secciones:
                        Costos Asociados, Seguros y Niveles de Riesgo del Scoring.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nuevo_nombre_linea" class="form-label">Nombre de la Línea de Crédito</label>
                                <input type="text" class="form-control" id="nuevo_nombre_linea" name="nombre_linea"
                                       placeholder="Ej: LoansiFlex Plus" required>
                                <div class="form-text">Este nombre aparecerá en el simulador y panel admin</div>
                            </div>

                            <div class="mb-3">
                                <label for="nueva_descripcion" class="form-label">Descripción</label>
                                <input type="text" class="form-control" id="nueva_descripcion" name="descripcion"
                                       placeholder="Ej: Crédito de libre inversión flexible" required>
                            </div>

                            <div class="mb-3">
                                <label for="nuevo_plazo_tipo" class="form-label">Tipo de Plazo</label>
                                <select class="form-select" id="nuevo_plazo_tipo" name="plazo_tipo" required>
                                    <option value="meses">Meses</option>
                                    <option value="semanas">Semanas</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nuevo_monto_min" class="form-label">Monto Mínimo</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="nuevo_monto_min" name="monto_min"
                                           placeholder="500.000" oninput="formatNumber(this)" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="nuevo_monto_max" class="form-label">Monto Máximo</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="nuevo_monto_max" name="monto_max"
                                           placeholder="50.000.000" oninput="formatNumber(this)" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="nuevo_plazo_min" class="form-label">Plazo Mínimo</label>
                                        <input type="number" class="form-control" id="nuevo_plazo_min" name="plazo_min"
                                               placeholder="6" min="1" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="nuevo_plazo_max" class="form-label">Plazo Máximo</label>
                                        <input type="number" class="form-control" id="nuevo_plazo_max" name="plazo_max"
                                               placeholder="72" min="1" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Tasas -->
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-percent me-2"></i>Configuración de Tasas Base</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nueva_tasa_anual" class="form-label">Tasa Efectiva Anual (E.A.)</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="nueva_tasa_anual" name="tasa_anual"
                                                   placeholder="25.12" value="25.12" required
                                                   oninput="actualizarTasaMensualNueva()">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Tasa Nominal Mensual (automática)</label>
                                        <div class="form-control" style="background-color: #f8f9fa;">
                                            <span id="nueva_tasa_mensual_mostrar">1.8851%</span>
                                        </div>
                                        <div class="form-text">Se calcula automáticamente desde la tasa anual</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="nuevo_aval_porcentaje" class="form-label">Porcentaje de Aval</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="nuevo_aval_porcentaje" name="aval_porcentaje"
                                           placeholder="10" value="10" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Porcentaje sobre el monto del crédito</div>
                            </div>
                        </div>
                        <!-- Configuración de Desembolso -->
                        <div class="card border-info mt-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-cash-coin me-2"></i>Configuración de Desembolso
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input type="hidden" name="permite_desembolso_neto" value="false" id="nueva_permite_desembolso_neto_hidden">
                                    <input class="form-check-input" type="checkbox"
                                           id="nueva_permite_desembolso_neto"
                                           name="permite_desembolso_neto_checkbox"
                                           onchange="document.getElementById('nueva_permite_desembolso_neto_hidden').value = this.checked ? 'true' : 'false';">
                                    <label class="form-check-label" for="nueva_permite_desembolso_neto">
                                        <strong>Permitir desembolso neto</strong>
                                        <br>
                                        <small class="text-muted">
                                            Los clientes podrán elegir si descontar los costos del desembolso
                                        </small>
                                    </label>
                                </div>

                                <div class="mb-0">
                                    <label class="form-label">Modalidad por defecto</label>
                                    <select class="form-select" name="desembolso_por_defecto">
                                        <option value="completo" selected>Desembolso completo (recomendado)</option>
                                        <option value="neto">Desembolso neto</option>
                                    </select>
                                    <div class="form-text">
                                        La modalidad que aparecerá seleccionada por defecto en el simulador
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Costos por Defecto -->
                    <div class="card border-secondary mt-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Costos Asociados Iniciales</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-text mb-3">Estos costos se crearán por defecto. Podrá modificarlos después en la sección "Costos Asociados".</div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Pagaré Digital</span>
                                        <input type="text" class="form-control" name="costo_pagare"
                                               value="2.800" oninput="formatNumber(this)">
                                    </div>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Carta de Instrucción</span>
                                        <input type="text" class="form-control" name="costo_carta"
                                               value="2.800" oninput="formatNumber(this)">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Consulta Datacrédito</span>
                                        <input type="text" class="form-control" name="costo_datacredito"
                                               value="11.000" oninput="formatNumber(this)">
                                    </div>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Custodia TVE</span>
                                        <input type="text" class="form-control" name="costo_custodia"
                                               value="5.600" oninput="formatNumber(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-2"></i>Crear Línea de Crédito
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Editar Línea de Crédito -->
<div class="modal fade" id="editarLineaCreditoModal" tabindex="-1" aria-labelledby="editarLineaCreditoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarLineaCreditoModalLabel">
                    <i class="bi bi-pencil me-2"></i>Editar Línea de Crédito
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formEditarLinea" method="post" action="/admin/lineas/editar">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" id="editar_nombre_original" name="nombre_original">

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Importante:</strong> Si cambias el nombre de la línea, se actualizará automáticamente en todas las secciones del sistema.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar_nombre_linea" class="form-label">Nombre de la Línea</label>
                                <input type="text" class="form-control" id="editar_nombre_linea" name="nombre_linea" required>
                                <div class="form-text">Este nombre aparecerá en el simulador y panel admin</div>
                            </div>

                            <div class="mb-3">
                                <label for="editar_descripcion" class="form-label">Descripción</label>
                                <input type="text" class="form-control" id="editar_descripcion" name="descripcion" required>
                                <div class="form-text">Descripción breve del producto</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar_plazo_tipo" class="form-label">Tipo de Plazo</label>
                                <select class="form-select" id="editar_plazo_tipo" name="plazo_tipo" required>
                                    <option value="meses">Meses</option>
                                    <option value="semanas">Semanas</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar_monto_min" class="form-label">Monto Mínimo</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="editar_monto_min" name="monto_min"
                                           oninput="formatNumber(this)" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar_monto_max" class="form-label">Monto Máximo</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="editar_monto_max" name="monto_max"
                                           oninput="formatNumber(this)" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="editar_plazo_min" class="form-label">Plazo Mínimo</label>
                                <input type="number" class="form-control" id="editar_plazo_min" name="plazo_min"
                                       min="1" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="editar_plazo_max" class="form-label">Plazo Máximo</label>
                                <input type="number" class="form-control" id="editar_plazo_max" name="plazo_max"
                                       min="1" required>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Desembolso -->
                        <div class="card border-info mt-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-cash-coin me-2"></i>Configuración de Desembolso
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input type="hidden" name="permite_desembolso_neto" value="false" id="editar_permite_desembolso_neto_hidden">
                                    <input class="form-check-input" type="checkbox"
                                           id="editar_permite_desembolso_neto"
                                           name="permite_desembolso_neto_checkbox"
                                           onchange="document.getElementById('editar_permite_desembolso_neto_hidden').value = this.checked ? 'true' : 'false';">
                                    <label class="form-check-label" for="editar_permite_desembolso_neto">
                                        <strong>Permitir desembolso neto</strong>
                                        <br>
                                        <small class="text-muted">
                                            Los clientes podrán elegir si descontar los costos del desembolso
                                        </small>
                                    </label>
                                </div>

                                <div class="mb-0">
                                    <label class="form-label">Modalidad por defecto</label>
                                    <select class="form-select" name="desembolso_por_defecto"
                                            id="editar_desembolso_por_defecto">
                                        <option value="completo">Desembolso completo (recomendado)</option>
                                        <option value="neto">Desembolso neto</option>
                                    </select>
                                    <div class="form-text">
                                        La modalidad que aparecerá seleccionada por defecto en el simulador
                                    </div>
                                </div>
                            </div>
                        </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal de Confirmación para Eliminar -->
<div class="modal fade" id="eliminarLineaCreditoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar la línea de crédito <strong id="eliminar_linea_nombre"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Advertencia:</strong> Esta acción eliminará la línea de crédito de todas las secciones
                    (Costos Asociados, Scoring, etc.) y no se puede deshacer.
                </div>
                <input type="hidden" id="eliminar_linea_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarEliminacionLinea()">Eliminar Línea</button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================
     MODAL PARA CREAR/EDITAR SECCIÓN (2025-12-26)
     ============================================ -->
<div class="modal fade" id="seccionModal" tabindex="-1" aria-labelledby="seccionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="seccionModalLabel">
                    <i class="bi bi-folder-plus me-2"></i>Nueva Sección
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="seccionForm">
                    <input type="hidden" id="seccion_id" value="">
                    <input type="hidden" id="seccion_is_new" value="true">

                    <div class="mb-3">
                        <label for="seccion_nombre" class="form-label">Nombre de la Sección</label>
                        <input type="text" class="form-control" id="seccion_nombre"
                               placeholder="Ej: Análisis de Probabilidad de Pago" required>
                    </div>

                    <div class="mb-3">
                        <label for="seccion_icono" class="form-label">Icono</label>
                        <select class="form-select" id="seccion_icono">
                            <option value="bi-graph-up">📊 Gráfico (Probabilidad)</option>
                            <option value="bi-cash-stack">💰 Dinero (Ingresos)</option>
                            <option value="bi-credit-card">💳 Tarjeta (Endeudamiento)</option>
                            <option value="bi-calendar-check">📅 Calendario (Historial)</option>
                            <option value="bi-building">🏢 Edificio (Sectorial)</option>
                            <option value="bi-file-earmark-check">📄 Documento (Verificación)</option>
                            <option value="bi-person-check">👤 Persona (Identidad)</option>
                            <option value="bi-shield-check">🛡️ Escudo (Seguridad)</option>
                            <option value="bi-lightning">⚡ Rayo (Alertas)</option>
                            <option value="bi-gear">⚙️ Engranaje (Configuración)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Color de la Sección</label>
                        <div class="color-picker-grid">
                            <div class="color-picker-item seccion-color-purple selected" data-color="purple" onclick="seleccionarColorSeccion(this)"></div>
                            <div class="color-picker-item seccion-color-blue" data-color="blue" onclick="seleccionarColorSeccion(this)"></div>
                            <div class="color-picker-item seccion-color-green" data-color="green" onclick="seleccionarColorSeccion(this)"></div>
                            <div class="color-picker-item seccion-color-orange" data-color="orange" onclick="seleccionarColorSeccion(this)"></div>
                            <div class="color-picker-item seccion-color-red" data-color="red" onclick="seleccionarColorSeccion(this)"></div>
                            <div class="color-picker-item seccion-color-teal" data-color="teal" onclick="seleccionarColorSeccion(this)"></div>
                            <div class="color-picker-item seccion-color-gray" data-color="gray" onclick="seleccionarColorSeccion(this)"></div>
                        </div>
                        <input type="hidden" id="seccion_color" value="purple">
                    </div>

                    <div class="mb-3">
                        <label for="seccion_descripcion" class="form-label">Descripción (opcional)</label>
                        <textarea class="form-control" id="seccion_descripcion" rows="2"
                                  placeholder="Breve descripción de lo que agrupa esta sección"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarSeccion()">
                    <i class="bi bi-check-lg me-1"></i>Guardar Sección
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminar Sección -->
<div class="modal fade" id="eliminarSeccionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Eliminar Sección</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de eliminar la sección <strong id="eliminar_seccion_nombre"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle me-2"></i>
                    Los criterios de esta sección se moverán a "Otros Criterios".
                </div>
                <input type="hidden" id="eliminar_seccion_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarEliminarSeccion()">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Función para actualizar tasa mensual en el modal de nueva línea
function actualizarTasaMensualNueva() {
    const tasaAnualInput = document.getElementById('nueva_tasa_anual');
    const tasaMensualSpan = document.getElementById('nueva_tasa_mensual_mostrar');

    const tasaAnual = tasaAnualInput.value.replace(',', '.');

    if (!isNaN(tasaAnual) && tasaAnual.trim() !== '') {
        const tasaMensual = calcularTasaMensual(tasaAnual);
        tasaMensualSpan.innerText = tasaMensual + '%';
    } else {
        tasaMensualSpan.innerText = 'Error';
    }
}

/// Función corregida para editar línea de crédito
function editarLineaCredito(nombreLinea) {
    const lineasCredito = {{ lineas_credito|tojson }};
    const datos = lineasCredito[nombreLinea];

    if (datos) {
        console.log('🔍 Editando línea:', nombreLinea);
        console.log('📊 Datos cargados:', datos);

        // Campos básicos
        document.getElementById('editar_nombre_original').value = nombreLinea;
        document.getElementById('editar_nombre_linea').value = nombreLinea;
        document.getElementById('editar_descripcion').value = datos.descripcion;
        document.getElementById('editar_plazo_tipo').value = datos.plazo_tipo;

        // Formatear montos
        document.getElementById('editar_monto_min').value = datos.monto_min.toLocaleString('es-CO');
        document.getElementById('editar_monto_max').value = datos.monto_max.toLocaleString('es-CO');

        document.getElementById('editar_plazo_min').value = datos.plazo_min;
        document.getElementById('editar_plazo_max').value = datos.plazo_max;

        // Configuración de desembolso
        const permitirNeto = document.getElementById('editar_permite_desembolso_neto');
        const modalidadDefecto = document.getElementById('editar_desembolso_por_defecto');

        if (permitirNeto) {
            permitirNeto.checked = datos.permite_desembolso_neto || false;

            // Sincronizar hidden con checkbox al cargar
            const hidden = document.getElementById('editar_permite_desembolso_neto_hidden');
            if (hidden) {
                hidden.value = datos.permite_desembolso_neto ? 'true' : 'false';
            }

            console.log('✅ Permite desembolso neto:', datos.permite_desembolso_neto);
        }

        if (modalidadDefecto) {
            modalidadDefecto.value = datos.desembolso_por_defecto || 'completo';
            console.log('✅ Modalidad por defecto:', datos.desembolso_por_defecto);
        }

        console.log('✅ Campos del formulario cargados correctamente');

        const modal = new bootstrap.Modal(document.getElementById('editarLineaCreditoModal'));
        modal.show();
    } else {
        console.error('❌ Error: Línea no encontrada:', nombreLinea);
        alert('Error: No se encontraron los datos de la línea de crédito');
    }
}

// Listener para el formulario de editar (debug y validación)
document.addEventListener('DOMContentLoaded', function() {
    const formEditarLinea = document.getElementById('formEditarLinea');

    if (formEditarLinea) {
        formEditarLinea.addEventListener('submit', function(e) {
            const nombreOriginal = document.getElementById('editar_nombre_original').value;
            const nombreNuevo = document.getElementById('editar_nombre_linea').value;

            console.log('🚀 Enviando formulario de edición...');
            console.log('📌 Nombre original:', nombreOriginal);
            console.log('📌 Nombre nuevo:', nombreNuevo);
            console.log('📌 Descripción:', document.getElementById('editar_descripcion').value);
            console.log('📌 Plazo tipo:', document.getElementById('editar_plazo_tipo').value);

            if (!nombreOriginal || nombreOriginal.trim() === '') {
                e.preventDefault();
                alert('❌ Error: No se detectó el nombre original de la línea. Intenta cerrar y abrir el modal nuevamente.');
                return false;
            }

            // Guardar tab activo antes de enviar
            saveCurrentTab();
        });
    }
});

// Función para eliminar línea de crédito
function eliminarLineaCredito(nombreLinea) {
    document.getElementById('eliminar_linea_nombre').textContent = nombreLinea;
    document.getElementById('eliminar_linea_id').value = nombreLinea;

    const modal = new bootstrap.Modal(document.getElementById('eliminarLineaCreditoModal'));
    modal.show();
}

// Confirmar eliminación
function confirmarEliminacionLinea() {
    const nombreLinea = document.getElementById('eliminar_linea_id').value;

    //  OBTENER TOKEN CSRF
    const csrfToken = getCSRFToken();

    // Crear form para eliminar
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/lineas/eliminar';

    //  AGREGAR TOKEN CSRF
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = 'csrf_token';
    tokenInput.value = csrfToken;
    form.appendChild(tokenInput);

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'nombre_linea';
    input.value = nombreLinea;

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

// Inicializar cuando se carga el documento
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar tasa mensual inicial en el modal
    actualizarTasaMensualNueva();
});
</script>

    <!-- Pestaña de Costos Asociados -->
    <div id="CostosAsociados" class="tabcontent">
    <h4 class="mb-4">Gestión de Costos Asociados</h4>

    <div class="row">
        {% for tipo_credito, costos in costos_asociados.items() %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ tipo_credito }}</h5>
                    <button type="button" class="btn btn-sm btn-success"
                            onclick="agregarCosto('{{ tipo_credito }}')">
                        <i class="bi bi-plus-circle"></i> Agregar Costo
                    </button>
                </div>
                <div class="card-body">
                    <form id="form-costos-{{ tipo_credito }}" method="post" action="/admin/costos">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="tipo_credito" value="{{ tipo_credito }}">
                        <input type="hidden" name="current_tab" value="CostosAsociados">

                        <div id="costos-container-{{ tipo_credito }}">
                            {% for costo, valor in costos.items() %}
                            <div class="mb-3 costo-row">
                                <div class="input-group">
                                    <span class="input-group-text">Costo</span>
                                    <input type="text"
                                           class="form-control nombre-costo"
                                           value="{{ costo }}"
                                           name="nombre_costo_{{ loop.index0 }}"
                                           required>
                                    <span class="input-group-text">$</span>
                                    <input type="text"
                                           name="valor_costo_{{ loop.index0 }}"
                                           value="{{ valor }}"
                                           class="form-control valor-costo"
                                           oninput="formatNumber(this)"
                                           required>
                                    <button type="button" class="btn btn-outline-danger"
                                            onclick="eliminarCosto(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Sección de aval como costo asociado -->
                        <div class="alert alert-info mt-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong><i class="bi bi-shield-check me-2"></i>Aval</strong>
                                    <div class="small text-muted">Porcentaje sobre el monto del crédito</div>
                                </div>
                                <div class="input-group" style="width: 160px;">
                                    <input type="text" class="form-control form-control-sm"
                                           name="aval_porcentaje"
                                           value="{{ lineas_credito[tipo_credito].aval_porcentaje * 100 }}"
                                           required>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- JavaScript para agregar/eliminar costos -->
<script>
// Variable global para mantener contadores de costos por tipo de crédito
var costosCounter = {};

// ============================================
// 🎯 VARIABLES GLOBALES DE SCORING
// ============================================

// Declarar primero en window para acceso global
window.scoringData = null;
window.criterioRangoCounter = 0;

// SECCIONES POR DEFECTO (2025-12-26)
const SECCIONES_DEFAULT = [
    { id: 'probabilidad_pago', nombre: 'Análisis de Probabilidad de Pago', icono: 'bi-graph-up', color: 'purple', orden: 0 },
    { id: 'ingresos', nombre: 'Análisis de Ingresos', icono: 'bi-cash-stack', color: 'green', orden: 1 },
    { id: 'endeudamiento', nombre: 'Análisis de Endeudamiento', icono: 'bi-credit-card', color: 'blue', orden: 2 },
    { id: 'comportamiento_pago', nombre: 'Comportamiento de Pago', icono: 'bi-calendar-check', color: 'orange', orden: 3 },
    { id: 'sectorial', nombre: 'Análisis Sectorial', icono: 'bi-building', color: 'teal', orden: 4 },
    { id: 'verificacion', nombre: 'Verificación Documental', icono: 'bi-file-earmark-check', color: 'red', orden: 5 },
    { id: 'otros', nombre: 'Otros Criterios', icono: 'bi-gear', color: 'gray', orden: 99 }
];

// Intentar cargar datos del servidor usando tojson de Jinja2
try {
    // ✅ Usar tojson para conversión automática Python → JavaScript
    window.scoringData = {{ scoring_json|tojson }};

    // CORRECCIÓN 2025-12-25: Ordenar criterios por campo 'orden' al cargar
    if (window.scoringData && window.scoringData.criterios) {
        const criteriosOrdenados = {};
        const entries = Object.entries(window.scoringData.criterios);

        // Ordenar por campo 'orden' (si existe) o mantener orden actual
        entries.sort((a, b) => {
            const ordenA = a[1].orden !== undefined ? a[1].orden : 9999;
            const ordenB = b[1].orden !== undefined ? b[1].orden : 9999;
            return ordenA - ordenB;
        });

        // Reconstruir objeto ordenado Y asignar seccion por defecto
        let criteriosSinSeccion = 0;
        entries.forEach(([key, value]) => {
            // CRÍTICO 2025-12-26: Asignar 'otros' a criterios sin sección
            if (!value.seccion) {
                value.seccion = 'otros';
                criteriosSinSeccion++;
            }
            criteriosOrdenados[key] = value;
        });

        window.scoringData.criterios = criteriosOrdenados;
        console.log('✅ Criterios ordenados por campo orden');
        if (criteriosSinSeccion > 0) {
            console.log(`✅ Asignada sección 'otros' a ${criteriosSinSeccion} criterios sin sección`);
        }
    }

    // INICIALIZAR SECCIONES (2025-12-26)
    if (!window.scoringData.secciones || window.scoringData.secciones.length === 0) {
        window.scoringData.secciones = JSON.parse(JSON.stringify(SECCIONES_DEFAULT));
        console.log('✅ Secciones inicializadas por defecto');
    }

    // Validar estructura
    if (!window.scoringData || typeof window.scoringData !== 'object') {
        throw new Error('scoringData no es un objeto válido');
    }

    if (!window.scoringData.criterios) {
        throw new Error('scoringData no tiene criterios');
    }

    console.log('✅ scoringData cargado correctamente:', {
        criterios: Object.keys(window.scoringData.criterios).length,
        factores: (window.scoringData.factores_rechazo_automatico || []).length,
        niveles: (window.scoringData.niveles_riesgo || []).length,
        secciones: (window.scoringData.secciones || []).length
    });

} catch (e) {
    console.error('❌ Error cargando scoringData:', e.message);
    console.error('❌ Stack:', e.stack);

    // Estructura mínima para evitar crashes
    window.scoringData = {
        criterios: {},
        factores_rechazo_automatico: [],
        niveles_riesgo: [
            {nivel: 'Bajo riesgo', min: 0, max: 17, color: '#28a745', tasa_anual: 0, tasa_mensual: 0},
            {nivel: 'Medio riesgo', min: 18, max: 21, color: '#ffc107', tasa_anual: 0, tasa_mensual: 0},
            {nivel: 'Alto riesgo', min: 22, max: 25, color: '#dc3545', tasa_anual: 0, tasa_mensual: 0}
        ],
        puntaje_minimo_aprobacion: 17,
        secciones: JSON.parse(JSON.stringify(SECCIONES_DEFAULT))
    };

    alert('⚠️ Error al cargar configuración de scoring.\n\nError: ' + e.message + '\n\nSe usará configuración por defecto. Revisa la consola para más detalles.');
}

// Alias globales para compatibilidad
var scoringData = window.scoringData;
var criterioRangoCounter = window.criterioRangoCounter;

console.log('🔍 Variables finales:', {
    scoringData: window.scoringData ? 'OK' : 'ERROR',
    criterios_count: Object.keys(window.scoringData.criterios || {}).length,
    criterioRangoCounter: window.criterioRangoCounter
});

// Inicializar factores de rechazo cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar contadores de costos
    {% for tipo_credito, costos in costos_asociados.items() %}
    costosCounter['{{ tipo_credito }}'] = {{ costos|length }};
    {% endfor %}

    // Configurar evento para cargar factores de rechazo
    const aprobacionTab = document.getElementById('aprobacion-tab');
    if (aprobacionTab) {
        aprobacionTab.addEventListener('shown.bs.tab', function() {
            cargarFactoresRechazo();
        });
    }

    // Si la pestaña de aprobación está activa al cargar, cargar factores
    const aprobacionContent = document.getElementById('aprobacion-content');
    if (aprobacionContent && aprobacionContent.classList.contains('active')) {
        setTimeout(cargarFactoresRechazo, 100);
    }
});

// Función para agregar un nuevo costo
function agregarCosto(tipoCredito) {
    const container = document.getElementById('costos-container-' + tipoCredito);
    const index = costosCounter[tipoCredito];
    costosCounter[tipoCredito]++;

    const nuevoCosto = document.createElement('div');
    nuevoCosto.className = 'mb-3 costo-row';
    nuevoCosto.innerHTML = `
        <div class="input-group">
            <span class="input-group-text">Costo</span>
            <input type="text"
                   class="form-control nombre-costo"
                   placeholder="Nombre del costo"
                   name="nombre_costo_${index}"
                   required>
            <span class="input-group-text">$</span>
            <input type="text"
                   name="valor_costo_${index}"
                   placeholder="0"
                   class="form-control valor-costo"
                   oninput="formatNumber(this)"
                   required>
            <button type="button" class="btn btn-outline-danger"
                    onclick="eliminarCosto(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;

    container.appendChild(nuevoCosto);
}

// Función para eliminar un costo
function eliminarCosto(boton) {
    if (confirm('¿Está seguro de eliminar este costo?')) {
        const costoRow = boton.closest('.costo-row');
        costoRow.remove();

        // Reordenar índices - con validación null-safe
        const form = boton.closest('form');
        const tipoCreditoInput = form ? form.querySelector('input[name="tipo_credito"]') : null;
        if (tipoCreditoInput) {
            renumerarCostos(tipoCreditoInput.value);
        }
    }
}

// Función para renumerar los índices de los costos después de eliminar
function renumerarCostos(tipoCredito) {
    const container = document.getElementById('costos-container-' + tipoCredito);
    const costoRows = container.querySelectorAll('.costo-row');

    costoRows.forEach((row, index) => {
        const nombreInput = row.querySelector('.nombre-costo');
        const valorInput = row.querySelector('.valor-costo');

        nombreInput.name = 'nombre_costo_' + index;
        valorInput.name = 'valor_costo_' + index;
    });

    // Actualizar contador
    costosCounter[tipoCredito] = costoRows.length;
}
</script>

<!-- Pestaña de Seguros -->
    <div id="Seguros" class="tabcontent">
        <h4 class="mb-4">Gestión de Seguros de Vida</h4>

        <div class="card">
            <div class="card-header">
                <h5>Configuración de Tarifas por Millón</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/admin/seguros" id="formSeguros">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="current_tab" value="Seguros">

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Nota:</strong> Estas tarifas son mensuales por cada millón de pesos del crédito.
                        El seguro se calcula como: <code>tarifa × millones × 12 × años</code>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered" id="tablaSeguros">
                            <thead>
                                <tr>
                                    <th width="15%">Edad Mínima</th>
                                    <th width="15%">Edad Máxima</th>
                                    <th width="25%">Costo Mensual</th>
                                    <th width="35%">Descripción</th>
                                    <th width="10%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="rangos-container">
                                {% if seguros_config is iterable and seguros_config is not string and seguros_config is not mapping %}
                                    {% for rango in seguros_config %}
                                    <tr class="rango-row" data-index="{{ loop.index0 }}">
                                        <td>
                                            <input type="number" class="form-control"
                                                   name="edad_min_{{ loop.index0 }}"
                                                   value="{{ rango.edad_min }}"
                                                   min="18" max="120" required>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control"
                                                   name="edad_max_{{ loop.index0 }}"
                                                   value="{{ rango.edad_max }}"
                                                   min="18" max="120" required>
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" class="form-control"
                                                       name="costo_{{ loop.index0 }}"
                                                       value="{{ rango.costo }}"
                                                       oninput="formatNumber(this)" required>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control"
                                                   name="descripcion_{{ loop.index0 }}"
                                                   value="{{ rango.descripcion }}"
                                                   placeholder="Ej: Jóvenes adultos">
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger"
                                                    onclick="eliminarRango(this)"
                                                    title="Eliminar rango">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <!-- Compatibilidad con estructura antigua -->
                                    <tr class="rango-row" data-index="0">
                                        <td><input type="number" class="form-control" name="edad_min_0" value="18" min="18" max="120" required></td>
                                        <td><input type="number" class="form-control" name="edad_max_0" value="45" min="18" max="120" required></td>
                                        <td>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" class="form-control" name="costo_0" value="{{ seguros_config.hasta_45 or 900 }}" oninput="formatNumber(this)" required>
                                            </div>
                                        </td>
                                        <td><input type="text" class="form-control" name="descripcion_0" value="Hasta 45 años"></td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarRango(this)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                    <tr class="rango-row" data-index="1">
                                        <td><input type="number" class="form-control" name="edad_min_1" value="46" min="18" max="120" required></td>
                                        <td><input type="number" class="form-control" name="edad_max_1" value="59" min="18" max="120" required></td>
                                        <td>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" class="form-control" name="costo_1" value="{{ seguros_config.hasta_59 or 1100 }}" oninput="formatNumber(this)" required>
                                            </div>
                                        </td>
                                        <td><input type="text" class="form-control" name="descripcion_1" value="46 a 59 años"></td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarRango(this)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                    <tr class="rango-row" data-index="2">
                                        <td><input type="number" class="form-control" name="edad_min_2" value="60" min="18" max="120" required></td>
                                        <td><input type="number" class="form-control" name="edad_max_2" value="100" min="18" max="120" required></td>
                                        <td>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" class="form-control" name="costo_2" value="{{ seguros_config.mas_60 or 1250 }}" oninput="formatNumber(this)" required>
                                            </div>
                                        </td>
                                        <td><input type="text" class="form-control" name="descripcion_2" value="60 años o más"></td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarRango(this)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <button type="button" class="btn btn-success mb-3" onclick="agregarRango()">
                        <i class="bi bi-plus-circle me-2"></i>Agregar Nuevo Rango
                    </button>

                    <button type="submit" class="btn btn-primary mb-3">
                        <i class="bi bi-save me-2"></i>Guardar Configuración
                    </button>
                </form>
            </div>
        </div>

        <!-- Script para gestión dinámica de rangos -->
        <script>
        let rangoCounter = {{ seguros_config|length if (seguros_config is iterable and seguros_config is not string and seguros_config is not mapping) else 3 }};

function agregarRango() {
    const container = document.getElementById('rangos-container');
    const newRow = document.createElement('tr');
    newRow.className = 'rango-row';
    newRow.dataset.index = rangoCounter;

    newRow.innerHTML = `
        <td>
            <input type="number" class="form-control" name="edad_min_${rangoCounter}"
                   value="18" min="18" max="120" required>
        </td>
        <td>
            <input type="number" class="form-control" name="edad_max_${rangoCounter}"
                   value="30" min="18" max="120" required>
        </td>
        <td>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" name="costo_${rangoCounter}"
                       value="900" oninput="formatNumber(this)" required>
            </div>
        </td>
        <td>
            <input type="text" class="form-control" name="descripcion_${rangoCounter}"
                   value="Nuevo rango" placeholder="Ej: Adultos mayores">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-danger"
                    onclick="eliminarRango(this)" title="Eliminar rango">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;

    container.appendChild(newRow);
    rangoCounter++;
}

function eliminarRango(button) {
    const rows = document.querySelectorAll('.rango-row');
    if (rows.length <= 1) {
        alert('Debe haber al menos un rango de seguro');
        return;
    }

    if (confirm('¿Está seguro de eliminar este rango?')) {
        button.closest('tr').remove();
        reindexarRangos();
    }
}

function reindexarRangos() {
    const rows = document.querySelectorAll('.rango-row');
    rows.forEach((row, index) => {
        row.dataset.index = index;

        // Actualizar nombres de inputs
        row.querySelectorAll('input').forEach(input => {
            const baseName = input.name.replace(/_\d+$/, '');
            input.name = `${baseName}_${index}`;
        });
    });
    rangoCounter = rows.length;
}
        </script>
    </div>

    <!-- Pestaña de Scoring -->
    <div id="Scoring" class="tabcontent">
    <h4 class="mb-4">
        <i class="bi bi-speedometer2 me-2"></i>Gestión de Scoring Interno
    </h4>

    <!-- Alerta informativa -->
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-start">
            <i class="bi bi-info-circle-fill me-3 fs-4"></i>
            <div>
                <strong>Sistema de Scoring Multi-Línea</strong>
                <p class="mb-0 mt-1">
                    Configure criterios de evaluación, niveles de riesgo y factores de rechazo 
                    <strong>independientes para cada línea de crédito</strong>. 
                    Seleccione la línea que desea configurar en el selector superior.
                </p>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- SELECTOR DE LÍNEA DE CRÉDITO (Nuevo componente principal) -->
    <!-- ================================================================== -->
    <div id="selectorLineaCreditoContainer">
        <!-- Se renderiza dinámicamente por JavaScript -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-box-seam me-2"></i>Cargando líneas de crédito...
            </div>
            <div class="card-body text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- PESTAÑAS DE CONFIGURACIÓN POR LÍNEA -->
    <!-- ================================================================== -->
    <ul class="nav nav-tabs mb-3" id="scoringLineaTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="niveles-linea-tab" data-bs-toggle="tab" 
                    data-bs-target="#niveles-linea-content" type="button" role="tab">
                <i class="bi bi-bar-chart-fill me-1"></i>Niveles de Riesgo
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="aprobacion-linea-tab" data-bs-toggle="tab" 
                    data-bs-target="#aprobacion-linea-content" type="button" role="tab">
                <i class="bi bi-check-circle me-1"></i>Configuración de Aprobación
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="criterios-linea-tab" data-bs-toggle="tab" 
                    data-bs-target="#criterios-linea-content" type="button" role="tab">
                <i class="bi bi-list-check me-1"></i>Criterios de Scoring
            </button>
        </li>
        <!-- Pestaña Global Legacy oculta - se mantiene como fallback interno -->
        <li class="nav-item ms-auto d-none" role="presentation">
            <button class="nav-link text-secondary" id="global-legacy-tab" data-bs-toggle="tab" 
                    data-bs-target="#global-legacy-content" type="button" role="tab"
                    title="Configuración global (compatibilidad)">
                <i class="bi bi-gear me-1"></i>Global (Legacy)
            </button>
        </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content" id="scoringLineaTabsContent">
        
        <!-- ============================================================ -->
        <!-- PESTAÑA: Niveles de Riesgo por Línea -->
        <!-- ============================================================ -->
        <div class="tab-pane fade show active" id="niveles-linea-content" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-bar-chart-fill me-2"></i>
                        Niveles de Riesgo y Tasas Diferenciadas
                    </span>
                    <span class="badge bg-primary" id="badgeLineaNiveles">-</span>
                </div>
                <div class="card-body">
                    <div id="nivelesRiesgoLineaContainer">
                        <!-- Renderizado dinámicamente -->
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-arrow-up-circle fs-1 d-block mb-2"></i>
                            Seleccione una línea de crédito arriba para configurar sus niveles de riesgo
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PESTAÑA: Configuración de Aprobación por Línea -->
        <!-- ============================================================ -->
        <div class="tab-pane fade" id="aprobacion-linea-content" role="tabpanel">
            <div id="aprobacionLineaContainer">
                <!-- Renderizado dinámicamente por JS -->
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-arrow-up-circle fs-1 d-block mb-2"></i>
                    Seleccione una línea de crédito arriba para configurar los parámetros de aprobación
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PESTAÑA: Criterios de Scoring por Línea -->
        <!-- ============================================================ -->
        <div class="tab-pane fade" id="criterios-linea-content" role="tabpanel">
            <div id="criteriosLineaContainer">
                <!-- Renderizado dinámicamente por JS -->
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-arrow-up-circle fs-1 d-block mb-2"></i>
                    Seleccione una línea de crédito arriba para configurar los criterios de scoring
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PESTAÑA: Configuración Global (Legacy/Fallback) -->
        <!-- ============================================================ -->
        <div class="tab-pane fade" id="global-legacy-content" role="tabpanel">
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Configuración Global (Legacy)</strong>: Esta configuración se usa como 
                fallback cuando una línea de crédito no tiene configuración específica.
                Se recomienda configurar cada línea individualmente.
            </div>
            
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="scoringGlobalTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="niveles-global-tab" 
                                    data-bs-toggle="tab" data-bs-target="#niveles-global-content" 
                                    type="button" role="tab">
                                <i class="bi bi-bar-chart-fill me-1"></i>Niveles de Riesgo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="criterios-global-tab" 
                                    data-bs-toggle="tab" data-bs-target="#criterios-global-content" 
                                    type="button" role="tab">
                                <i class="bi bi-list-check me-1"></i>Criterios
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="aprobacion-global-tab" 
                                    data-bs-toggle="tab" data-bs-target="#aprobacion-global-content" 
                                    type="button" role="tab">
                                <i class="bi bi-gear-fill me-1"></i>Aprobación
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="scoringGlobalTabsContent">
                        
                        <div class="tab-pane fade show active" id="niveles-global-content" role="tabpanel">
                            <!-- Sección de Niveles de Riesgo -->
                            <div class="scoring-section">
                                <div class="scoring-header">
                                    <h5 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Niveles de Riesgo y Tasas Diferenciadas</h5>
                                </div>

                                <div class="row mb-3">
                                    {% for nivel in niveles_riesgo %}
                                    {% set nivel_loop_index = loop.index0 %}
                                    <div class="col-md-4 mb-3">
                                        <div class="nivel-riesgo-card" style="background-color: {{ nivel.color }};">
                                            <div class="mb-2">
                                                <input type="text" class="form-control form-control-sm nivel-input"
                                                       value="{{ nivel.nombre }}"
                                                       data-index="{{ nivel_loop_index }}"
                                                       data-field="nombre"
                                                       onchange="updateNivelRiesgo({{ nivel_loop_index }}, 'nombre', this.value)">
                                            </div>
                                            <div class="d-flex mb-2">
                                                <div class="input-group input-group-sm me-1">
                                                    <span class="input-group-text">Min</span>
                                                    <input type="number" class="form-control form-control-sm nivel-input"
                                                           value="{{ nivel.min }}"
                                                           min="0" max="100"
                                                           data-index="{{ nivel_loop_index }}"
                                                           data-field="min"
                                                           onchange="updateNivelRiesgo({{ nivel_loop_index }}, 'min', this.value)">
                                                </div>
                                                <div class="input-group input-group-sm ms-1">
                                                    <span class="input-group-text">Max</span>
                                                    <input type="number" class="form-control form-control-sm nivel-input"
                                                           value="{{ nivel.max }}"
                                                           min="0" max="100"
                                                           data-index="{{ nivel_loop_index }}"
                                                           data-field="max"
                                                           onchange="updateNivelRiesgo({{ nivel_loop_index }}, 'max', this.value)">
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-end mb-2">
                                                <input type="color" class="form-control form-control-sm nivel-input"
                                                       value="{{ nivel.color }}"
                                                       style="width: 50px; height: 31px;"
                                                       data-index="{{ nivel_loop_index }}"
                                                       data-field="color"
                                                       onchange="updateNivelRiesgo({{ nivel_loop_index }}, 'color', this.value)">
                                            </div>

                                            <!-- Tasas diferenciadas por producto -->
                                            <div class="tasas-riesgo mt-2 p-2 bg-white rounded">
                                                <h6 class="border-bottom pb-1 mb-2">Tasas para este nivel</h6>

                                                {% for tipo_credito in lineas_credito %}
                                                <div class="mb-3 p-2 rounded" style="background-color: #f8f9fa; border-left: 3px solid #0d6efd;">
                                                    <div class="d-flex justify-content-start align-items-center mb-2">
                                                        {% if tipo_credito == "LoansiFlex" %}
                                                        <span class="badge" style="background-color: #0078D7; color: white; font-weight: bold; padding: 5px 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">{{ tipo_credito }}</span>
                                                        {% else %}
                                                        <span class="badge" style="background-color: #00B294; color: white; font-weight: bold; padding: 5px 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">{{ tipo_credito }}</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="input-group input-group-sm mb-1">
                                                        <span class="input-group-text">E.A.</span>
                                                        <input type="number" step="0.01" class="form-control form-control-sm nivel-tasa-input"
                                                               value="{{ nivel.tasas_por_producto[tipo_credito].tasa_anual if nivel.tasas_por_producto and nivel.tasas_por_producto[tipo_credito] else lineas_credito[tipo_credito].tasa_anual }}"
                                                               data-index="{{ loop.index0 }}"
                                                               data-tipo="{{ tipo_credito }}"
                                                               data-field="tasa_anual"
                                                               data-nivel-index="{{ nivel_loop_index }}"
                                                               onchange="updateNivelTasa({{ nivel_loop_index }}, '{{ tipo_credito }}', 'tasa_anual', this.value)"
                                                               onblur="this.value = parseFloat(this.value).toFixed(2)">
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">Nom. Mensual</span>
                                                        <input type="number" step="0.0001" class="form-control form-control-sm nivel-tasa-input"
                                                               value="{{ nivel.tasas_por_producto[tipo_credito].tasa_mensual if nivel.tasas_por_producto and nivel.tasas_por_producto[tipo_credito] else lineas_credito[tipo_credito].tasa_mensual }}"
                                                               data-index="{{ loop.index0 }}"
                                                               data-tipo="{{ tipo_credito }}"
                                                               data-field="tasa_mensual"
                                                               data-nivel-index="{{ nivel_loop_index }}"
                                                               onchange="updateNivelTasa({{ nivel_loop_index }}, '{{ tipo_credito }}', 'tasa_mensual', this.value)"
                                                               onblur="this.value = parseFloat(this.value).toFixed(4)">
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="mt-3 p-2 bg-white rounded">
    <h6 class="border-bottom pb-1 mb-2">
        <i class="bi bi-shield-check me-1"></i>Aval por Producto (% del monto)
    </h6>

    {% for tipo_credito in lineas_credito %}
    <div class="mb-3 p-2 rounded" style="background-color: #fff8e1; border-left: 3px solid #ff9800;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            {% if tipo_credito == "LoansiFlex" %}
            <span class="badge" style="background-color: #0078D7; color: white; font-weight: bold; padding: 5px 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">{{ tipo_credito }}</span>
            {% else %}
            <span class="badge" style="background-color: #00B294; color: white; font-weight: bold; padding: 5px 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">{{ tipo_credito }}</span>
            {% endif %}
            <span class="badge bg-warning text-dark">Aval Dinámico</span>
        </div>
        <div class="input-group input-group-sm">
            <input type="text"
                   inputmode="decimal"
                   pattern="[0-9]*[.,]?[0-9]*"
                   class="form-control form-control-sm nivel-aval-input"
                   value="{{ '%.2f'|format((nivel.aval_por_producto[tipo_credito] * 100) if nivel.aval_por_producto and nivel.aval_por_producto[tipo_credito] else (lineas_credito[tipo_credito].aval_porcentaje * 100)) }}"
                   data-tipo="{{ tipo_credito }}"
                   data-nivel-index="{{ nivel_loop_index }}"
                   onfocus="this.select()"
                   onblur="formatAvalInput(this)"
                   onchange="updateNivelAval({{ nivel_loop_index }}, '{{ tipo_credito }}', this.value)">
            <span class="input-group-text">%</span>
        </div>
        <small class="text-muted">Porcentaje del monto que se cobra como aval</small>
    </div>
    {% endfor %}
</div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="criterios-global-content" role="tabpanel">
                            <div class="scoring-section">
                                <div class="scoring-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Gestión de Criterios de Scoring</h5>
                                    <button type="button" class="btn btn-success btn-sm" onclick="addNewCriterio()">
                                        <i class="bi bi-plus-circle"></i> Nuevo Criterio
                                    </button>
                                </div>

                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <strong>Precaución:</strong> Añadir o eliminar criterios puede afectar significativamente los resultados del scoring.
                                    Asegúrese de revisar y ajustar los pesos para que sumen 100%.
                                </div>

                                <!-- Lista de criterios organizados por SECCIONES (2025-12-26) -->
                                <div id="secciones-container" class="mt-3">
                                    <!-- Las secciones se renderizan dinámicamente por JavaScript -->
                                </div>

                                <!-- Botón para agregar nueva sección -->
                                <div class="text-center mt-3 mb-4">
                                    <button type="button" class="btn btn-outline-secondary" onclick="mostrarModalSeccion()">
                                        <i class="bi bi-folder-plus me-1"></i> Nueva Sección
                                    </button>
                                </div>

                                <!-- Lista de criterios (renderizado por JS, este bloque es fallback/referencia) -->
                                <div id="criterios-list" class="mt-3" style="display:none;">
                                    <!-- Los criterios ahora se muestran dentro de las secciones -->
                                    {% for criterio_id, criterio in scoring_criterios.items() %}
                                    <div class="scoring-criteria-row mb-3" id="criterio-{{ criterio_id }}"
                                         draggable="true"
                                         data-criterio-id="{{ criterio_id }}"
                                         data-seccion="{{ criterio.seccion|default('otros') }}">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center">
                                                <!-- DRAG HANDLE -->
                                                <span class="drag-handle me-2" title="Arrastrar para reordenar">
                                                    <i class="bi bi-grip-vertical fs-5"></i>
                                                </span>
                                                <span class="badge badge-peso me-2">{{ criterio.peso }}%</span>
                                                <h6 class="mb-0">{{ criterio.nombre }}</h6>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-outline-primary btn-sm me-1"
                                                        onclick="editCriterio('{{ criterio_id }}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger btn-sm"
                                                        onclick="deleteCriterio('{{ criterio_id }}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Tabla de rangos -->
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered table-hover">
                                                <thead class="table-primary">
                                                    <tr>
                                                        <th style="width: 10%;">Mínimo</th>
                                                        <th style="width: 10%;">Máximo</th>
                                                        <th style="width: 12%;">Puntos</th>
                                                        <th style="width: 48%;">Descripción</th>
                                                        <th style="width: 20%;" class="text-center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% if criterio.rangos and criterio.rangos|length > 0 %}
                                                        {% if criterio.tipo_campo == 'composite' %}
                                                            <!-- CRITERIOS COMPOSITE: Mostrar solo condición/puntos/descripción -->
                                                            {% for rango in criterio.rangos %}
                                                            <tr>
                                                                <td colspan="2" class="align-middle">
                                                                    <span class="badge bg-secondary">
                                                                        {{ rango.condicion|default('condición_auto') }}
                                                                    </span>
                                                                </td>
                                                                <td class="align-middle">
                                                                    <span class="badge {% if rango.puntos >= 20 %}bg-success{% elif rango.puntos >= 10 %}bg-info{% elif rango.puntos >= 0 %}bg-secondary{% else %}bg-danger{% endif %}">
                                                                        {{ rango.puntos }} pts
                                                                    </span>
                                                                </td>
                                                                <td class="align-middle">
                                                                    {% if '⚠️' in rango.descripcion or 'ALERTA' in rango.descripcion %}
                                                                        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                                                                    {% elif '🚨' in rango.descripcion or 'muy' in rango.descripcion|lower %}
                                                                        <i class="bi bi-exclamation-circle-fill text-danger me-1"></i>
                                                                    {% endif %}
                                                                    {{ rango.descripcion }}
                                                                </td>
                                                                <td class="text-center align-middle">
                                                                    <span class="badge bg-primary" title="Rango calculado automáticamente">
                                                                        <i class="bi bi-calculator"></i> Auto
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <!-- CRITERIOS NORMALES: Mostrar min/max/puntos/descripción -->
                                                            {% for rango in criterio.rangos %}
                                                            <tr>
                                                                <td class="align-middle"><strong>{{ rango.min }}</strong></td>
                                                                <td class="align-middle"><strong>{{ rango.max }}</strong></td>
                                                                <td class="align-middle">
                                                                    <span class="badge {% if rango.puntos >= 20 %}bg-success{% elif rango.puntos >= 10 %}bg-info{% elif rango.puntos >= 0 %}bg-secondary{% else %}bg-danger{% endif %}">
                                                                        {{ rango.puntos }} pts
                                                                    </span>
                                                                </td>
                                                                <td class="align-middle">{{ rango.descripcion }}</td>
                                                                <td class="text-center align-middle">
                                                                    <div class="btn-group btn-group-sm" role="group">
                                                                        <button type="button" class="btn btn-outline-primary"
                                                                                onclick="editRango('{{ criterio_id }}', {{ loop.index0 }})"
                                                                                title="Editar rango">
                                                                            <i class="bi bi-pencil"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-outline-danger"
                                                                                onclick="deleteRango('{{ criterio_id }}', {{ loop.index0 }})"
                                                                                title="Eliminar rango">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% else %}
                                                        <!-- Sin rangos configurados -->
                                                        <tr>
                                                            <td colspan="5" class="text-center text-muted py-3">
                                                                <i class="bi bi-inbox me-2"></i>No hay rangos configurados.
                                                                <button type="button" class="btn btn-sm btn-link"
                                                                        onclick="editCriterio('{{ criterio_id }}')">
                                                                    {% if criterio.tipo_campo == 'composite' %}
                                                                        Ver Configuración
                                                                    {% else %}
                                                                        Agregar rangos
                                                                    {% endif %}
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="text-end mt-2">
                                            <button type="button" class="btn btn-success btn-sm"
                                                    onclick="addRango('{{ criterio_id }}')">
                                                <i class="bi bi-plus-circle me-1"></i> Añadir Rango
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="aprobacion-global-content" role="tabpanel">
                            <div class="scoring-section">
                                <div class="scoring-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Configuración de Aprobación</h5>
                                    <!-- Botón redundante eliminado -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Puntaje Mínimo para Aprobación</label>
                                    <input type="number" id="puntajeMinimo" class="form-control"
                                           value="{{ scoring_json.puntaje_minimo_aprobacion }}"
                                           min="0" max="100"
                                           onchange="updatePuntajeMinimo(this.value)">
                                    <div class="form-text">Clientes con puntaje igual o superior a este valor serán aprobados automáticamente</div>
                                </div>

                                <!-- Umbral Mora Telcos -->
                                <div class="mb-3">
                                    <label class="form-label">💰 Umbral Mora Telcos (Rechazo Automático)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text"
                                               id="umbralMoraTelcos"
                                               class="form-control"
                                               value="{{ '{:,.0f}'.format(scoring_json.umbral_mora_telcos_rechazo | default(200000)) }}"
                                               data-tipo="currency"
                                               onchange="updateUmbralMoraTelcos(this.value)">
                                    </div>
                                    <div class="form-text">
                                        Monto máximo permitido de mora en Telcos. Si supera este valor, será <strong>rechazo automático</strong>.
                                        Si es menor o igual, se aplica tasa de Riesgo Moderado.
                                    </div>
                                </div>

                                <!-- JavaScript función guardar -->
                                <script>
                                function updateUmbralMoraTelcos(valor) {
                                    // Limpiar formato
                                    const valorNum = parseFloat(valor.replace(/,/g, '').replace('$', ''));

                                    fetch('/admin/actualizar_umbral_mora_telcos', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': getCSRFToken()
                                        },
                                        body: JSON.stringify({ umbral: valorNum })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            alert('✅ Umbral de mora telcos actualizado exitosamente');
                                        } else {
                                            alert('❌ Error: ' + data.error);
                                        }
                                    });
                                }
                                </script>

                                <!-- Factores de Rechazo Automático -->
                                <div class="card border-danger mb-4">
                                    <div class="card-header bg-danger text-white d-flex align-items-center">
                                        <i class="bi bi-exclamation-octagon me-2 fs-5"></i>
                                        <h5 class="mb-0">Factores de Rechazo Automático</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-danger">Estos criterios significan rechazo automático, debes verificar claramente antes de aprobar:</p>

                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Criterio</th>
                                                        <th>Valor Mínimo</th>
                                                        <th>Mensaje claro para rechazo</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="factores-rechazo-body">
                                                    <!-- Se llenará dinámicamente con JavaScript -->
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="text-end">
                                            <button type="button" class="btn btn-success" onclick="agregarFactorRechazo()">
                                                <i class="bi bi-plus-circle me-1"></i> Agregar Factor de Rechazo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div><!-- /tab-content -->

</div><!-- /Scoring tabcontent -->

<!-- ====================================================================== -->
<!-- ESTILOS ADICIONALES PARA SCORING MULTI-LÍNEA -->
<!-- ====================================================================== -->
<style>
/* Selector de línea de crédito destacado */
#selectorLineaCreditoContainer .card {
    box-shadow: 0 0 15px rgba(13, 110, 253, 0.15);
}

#selectorLineaCreditoContainer .card-header {
    font-weight: 600;
}

/* Badge de línea actual */
#badgeLineaActual {
    font-size: 0.9rem;
    padding: 0.4rem 0.8rem;
}

/* Pestañas de scoring por línea */
#scoringLineaTabs .nav-link {
    color: var(--bs-gray-600);
    border: none;
    padding: 0.75rem 1.25rem;
    transition: all 0.2s;
}

#scoringLineaTabs .nav-link:hover {
    color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.05);
}

#scoringLineaTabs .nav-link.active {
    color: var(--bs-primary);
    font-weight: 600;
    border-bottom: 3px solid var(--bs-primary);
    background-color: transparent;
}

/* Cards de niveles de riesgo */
#nivelesRiesgoLineaContainer .card {
    transition: transform 0.2s, box-shadow 0.2s;
}

#nivelesRiesgoLineaContainer .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Tabla de factores de rechazo */
#factoresRechazoLineaContainer .table th {
    background-color: var(--bs-gray-800);
    color: white;
    font-weight: 500;
}

#factoresRechazoLineaContainer .table td {
    vertical-align: middle;
}

/* Tema oscuro */
[data-theme="dark"] #selectorLineaCreditoContainer .card {
    box-shadow: 0 0 15px rgba(13, 110, 253, 0.25);
}

[data-theme="dark"] #scoringLineaTabs .nav-link {
    color: var(--bs-gray-400);
}

[data-theme="dark"] #scoringLineaTabs .nav-link:hover {
    background-color: rgba(13, 110, 253, 0.15);
}

[data-theme="dark"] #scoringLineaTabs .nav-link.active {
    color: var(--bs-primary);
}

[data-theme="dark"] #nivelesRiesgoLineaContainer .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Responsive */
@media (max-width: 768px) {
    #scoringLineaTabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    #scoringLineaTabs .nav-link {
        white-space: nowrap;
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
    
    #nivelesRiesgoLineaContainer .col-md-4 {
        margin-bottom: 1rem;
    }
}
</style>

<!-- ====================================================================== -->
<!-- SCRIPT: Cargar JavaScript de scoring multi-línea -->
<!-- ====================================================================== -->
<script src="/static/js/admin-scoring-multilinea.js"></script>

    <!-- Modal para cambiar contraseña -->

    <!-- Modal para cambiar contraseña -->
    <div class="modal fade" id="cambiarPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambiar Contraseña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="/admin/usuario/cambiar-password">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="current_tab" value="Usuarios">
                    <div class="modal-body">
                        <input type="hidden" name="username" id="modalUsername">
                        <div class="mb-3">
                            <label class="form-label">Nueva Contraseña</label>
                            <input type="password" name="new_password" class="form-control" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Editar/Crear Criterio -->
    <div class="modal fade" id="criterioModal" tabindex="-1" aria-labelledby="criterioModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="criterioModalLabel">Editar Criterio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="criterioForm">
                        <input type="hidden" id="criterio_id" name="criterio_id">
                        <input type="hidden" id="isNew" name="isNew" value="false">

                        <div class="mb-3">
                            <label for="criterio_nombre" class="form-label">Nombre del Criterio</label>
                            <input type="text" class="form-control" id="criterio_nombre" name="criterio_nombre" required>
                        </div>

                        <div class="mb-3">
                            <label for="criterio_peso" class="form-label">Peso (%)</label>
                            <input type="number" class="form-control" id="criterio_peso" name="criterio_peso"
                                   min="1" max="100" required>
                            <div class="form-text">El porcentaje que este criterio contribuye al puntaje final. Todos los pesos deben sumar 100%.</div>
                        </div>

                        <div class="mb-3">
                            <label for="criterio_tipo" class="form-label">Tipo de Campo</label>
                            <select class="form-select" id="criterio_tipo" name="criterio_tipo" required onchange="toggleCampoOpciones()">
                                <option value="number">Número</option>
                                <option value="text">Texto</option>
                                <option value="select">Lista Desplegable</option>
                                <option value="currency">Moneda</option>
                                <option value="percentage">Porcentaje</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="criterio_placeholder" class="form-label">Placeholder</label>
                            <input type="text" class="form-control" id="criterio_placeholder" name="criterio_placeholder"
                                   placeholder="Ej: Ingrese valor">
                        </div>

                        <div class="mb-3">
                            <label for="criterio_ayuda" class="form-label">Texto de Ayuda</label>
                            <textarea class="form-control" id="criterio_ayuda" name="criterio_ayuda" rows="3"
                                      placeholder="Texto que aparecerá como ayuda al usuario"></textarea>
                        </div>

                        <div id="opciones_select" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Opciones para Lista Desplegable</label>
                                <div id="opciones_container">
                                    <!-- Se llenarán dinámicamente -->
                                </div>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="agregarOpcion()">
                                    <i class="bi bi-plus-circle"></i> Agregar Opción
                                </button>
                            </div>
                        </div>

                        <div class="row" id="rango_numerico">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="criterio_min" class="form-label">Valor Mínimo</label>
                                    <input type="number" class="form-control" id="criterio_min" name="criterio_min">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="criterio_max" class="form-label">Valor Máximo</label>
                                    <input type="number" class="form-control" id="criterio_max" name="criterio_max">
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-4 mb-3">Rangos de Evaluación</h6>
                        <div id="rangos_container">
                            <!-- Aquí se cargarán los rangos dinámicamente -->
                        </div>

                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-outline-success" onclick="addRangoToForm()">
                                <i class="bi bi-plus-circle"></i> Añadir Rango
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveCriterio()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div class="modal fade" id="deleteCriterioModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar este criterio? Esta acción no se puede deshacer.</p>
                    <p class="text-danger"><strong>Advertencia:</strong> Eliminar un criterio afectará a todos los cálculos de scoring futuros.</p>
                    <input type="hidden" id="criterio_eliminar_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteCriterio()">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestaña de Capacidad de Pago -->
    <div id="CapacidadPago" class="tabcontent">
        <h4 class="mb-4">Parámetros de Capacidad de Endeudamiento</h4>

        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Nota:</strong> Estos parámetros controlan los límites de endeudamiento recomendados en el módulo de Capacidad de Pago.
            Los cambios se aplican inmediatamente a todos los asesores.
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-sliders me-2"></i>Configuración de Límites</h5>
                    </div>
                    <div class="card-body">
                        <form id="formCapacidadParametros">
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-shield-check text-success me-2"></i>Límite Conservador (%)
                                    </label>
                                    <input type="number"
                                           class="form-control form-control-lg text-center"
                                           id="limite_conservador"
                                           min="10"
                                           max="50"
                                           value="30"
                                           required>
                                    <small class="text-muted">Recomendado para la mayoría de créditos</small>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-shield text-warning me-2"></i>Límite Máximo (%)
                                    </label>
                                    <input type="number"
                                           class="form-control form-control-lg text-center"
                                           id="limite_maximo"
                                           min="10"
                                           max="50"
                                           value="35"
                                           required>
                                    <small class="text-muted">Con scoring alto y garantías</small>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-shield-exclamation text-danger me-2"></i>Límite Absoluto (%)
                                    </label>
                                    <input type="number"
                                           class="form-control form-control-lg text-center"
                                           id="limite_absoluto"
                                           min="10"
                                           max="60"
                                           value="40"
                                           required>
                                    <small class="text-muted">Solo casos excepcionales</small>
                                </div>
                            </div>

                            <hr>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Descripción del Límite Conservador</label>
                                <input type="text"
                                       class="form-control"
                                       id="descripcion_conservador"
                                       value="Recomendado para créditos de libre inversión (protege al cliente)"
                                       maxlength="200">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Descripción del Límite Máximo</label>
                                <input type="text"
                                       class="form-control"
                                       id="descripcion_maximo"
                                       value="Límite máximo con scoring alto y garantías"
                                       maxlength="200">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Descripción del Límite Absoluto</label>
                                <input type="text"
                                       class="form-control"
                                       id="descripcion_absoluto"
                                       value="Solo casos excepcionales con scoring excelente + garantías sólidas"
                                       maxlength="200">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Notas Internas (Opcional)</label>
                                <textarea class="form-control"
                                          id="notas_capacidad"
                                          rows="3"
                                          maxlength="500"
                                          placeholder="Ej: Políticas actualizadas según análisis de cartera vencida..."></textarea>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="button"
                                        class="btn btn-primary btn-lg"
                                        onclick="guardarParametrosCapacidad()">
                                    <i class="bi bi-save me-2"></i>Guardar Configuración
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card bg-light h-100">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-lightbulb text-warning me-2"></i>Recomendaciones Profesionales
                        </h6>

                        <div class="alert alert-success">
                            <strong>Límite Conservador (30%):</strong>
                            <ul class="mb-0 mt-2 small">
                                <li>Créditos pequeños (&lt;$5MM)</li>
                                <li>Clientes nuevos</li>
                                <li>Scoring bajo-medio</li>
                            </ul>
                        </div>

                        <div class="alert alert-warning">
                            <strong>Límite Máximo (35%):</strong>
                            <ul class="mb-0 mt-2 small">
                                <li>Créditos medianos ($5-15MM)</li>
                                <li>Buen historial crediticio</li>
                                <li>Scoring alto (700-850)</li>
                            </ul>
                        </div>

                        <div class="alert alert-danger">
                            <strong>Límite Absoluto (40%):</strong>
                            <ul class="mb-0 mt-2 small">
                                <li>Créditos grandes (&gt;$15MM)</li>
                                <li>Scoring excelente (&gt;850)</li>
                                <li>Con garantías sólidas</li>
                                <li>Evaluación caso por caso</li>
                            </ul>
                        </div>

                        <hr>

                        <h6 class="fw-bold mb-2">
                            <i class="bi bi-exclamation-triangle text-danger me-2"></i>Advertencia
                        </h6>
                        <p class="small mb-0">
                            Porcentajes muy altos (&gt;40%) pueden causar sobreendeudamiento del cliente.
                            Considere que el cliente debe cubrir vivienda, alimentación, transporte y otros gastos con el restante del ingreso.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         PESTAÑA DE PERMISOS GRANULARES
         Sistema RBAC + Permisos por Usuario
         ============================================ -->
    <div id="Permisos" class="tabcontent">
        {% if not tiene_permiso('usr_permisos') %}
        <!-- Mensaje de acceso denegado para usuarios sin permiso -->
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="bi bi-shield-exclamation me-3" style="font-size: 2rem;"></i>
            <div>
                <h5 class="alert-heading mb-1">Acceso Denegado</h5>
                <p class="mb-0">No tienes permiso para gestionar permisos del sistema.
                   Contacta a un administrador si necesitas acceso.</p>
            </div>
        </div>
        {% else %}
        <h4 class="mb-4">
            <i class="bi bi-shield-lock me-2"></i>Gestión de Permisos
        </h4>

        <div class="row">
            <!-- Panel izquierdo: Información y estadísticas -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Sistema de Permisos</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">
                            El sistema usa <strong>permisos por rol</strong> más <strong>excepciones por usuario</strong>.
                            Cada usuario hereda los permisos de su rol, pero puedes agregar o quitar permisos específicos.
                        </p>

                        <hr>

                        <h6 class="fw-bold mb-2"><i class="bi bi-bar-chart me-1"></i>Estadísticas</h6>
                        <div id="permisosStats" class="small">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Total permisos:</span>
                                <span class="badge bg-primary" id="totalPermisos">-</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Roles configurados:</span>
                                <span class="badge bg-success" id="totalRoles">7</span>
                            </div>
                        </div>

                        <hr>

                        <h6 class="fw-bold mb-2"><i class="bi bi-people me-1"></i>Roles Disponibles</h6>
                        <div class="list-group list-group-flush small" id="listaRoles">
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span><i class="bi bi-person text-secondary me-1"></i>Asesor</span>
                                <span class="badge bg-secondary" id="permisosAsesor">-</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span><i class="bi bi-person-badge text-info me-1"></i>Supervisor</span>
                                <span class="badge bg-info" id="permisosSupervisor">-</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span><i class="bi bi-eye text-warning me-1"></i>Auditor</span>
                                <span class="badge bg-warning text-dark" id="permisosAuditor">-</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span><i class="bi bi-briefcase text-success me-1"></i>Gerente</span>
                                <span class="badge bg-success" id="permisosGerente">-</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span><i class="bi bi-gear text-primary me-1"></i>Admin Técnico</span>
                                <span class="badge bg-primary" id="permisosAdminTecnico">-</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span><i class="bi bi-people-fill text-danger me-1"></i>Comité Crédito</span>
                                <span class="badge bg-danger" id="permisosComite">-</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                                <span><i class="bi bi-shield-fill-check text-dark me-1"></i>Admin</span>
                                <span class="badge bg-dark" id="permisosAdmin">TODOS</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel derecho: Gestión de permisos por usuario -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-person-gear me-2"></i>Permisos por Usuario</h5>
                        <button class="btn btn-sm btn-light" onclick="cargarPermisosUsuarios()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">
                            Selecciona un usuario para ver/modificar sus permisos. Los permisos <span class="text-success">✓ verdes</span> vienen del rol,
                            <span class="text-primary">+ azules</span> son agregados manualmente, y <span class="text-danger">- rojos</span> están quitados.
                        </p>

                        <!-- Selector de usuario -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar Usuario:</label>
                            <select class="form-select" id="selectorUsuarioPermisos" onchange="cargarPermisosUsuario(this.value)">
                                <option value="">-- Selecciona un usuario --</option>
                                {% for username, user_data in usuarios.items() %}
                                <option value="{{ username }}" data-rol="{{ user_data.rol }}">
                                    {{ user_data.nombre_completo or username }} ({{ user_data.rol }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Contenedor de permisos del usuario -->
                        <div id="contenedorPermisosUsuario" style="display: none;">
                            <div class="alert alert-info mb-3" id="infoUsuarioSeleccionado">
                                <strong id="nombreUsuarioSeleccionado">-</strong>
                                <span class="badge bg-secondary ms-2" id="rolUsuarioSeleccionado">-</span>
                            </div>

                            <!-- Tabs de módulos de permisos -->
                            <ul class="nav nav-pills nav-fill mb-3" id="modulosPermisosTabs">
                                <li class="nav-item">
                                    <button class="nav-link active" onclick="mostrarModuloPermisos('simulador')">
                                        <i class="bi bi-calculator"></i> Simulador
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" onclick="mostrarModuloPermisos('scoring')">
                                        <i class="bi bi-graph-up"></i> Scoring
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" onclick="mostrarModuloPermisos('comite')">
                                        <i class="bi bi-people"></i> Comité
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" onclick="mostrarModuloPermisos('config')">
                                        <i class="bi bi-gear"></i> Config
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" onclick="mostrarModuloPermisos('usuarios')">
                                        <i class="bi bi-person"></i> Usuarios
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" onclick="mostrarModuloPermisos('reportes')">
                                        <i class="bi bi-file-earmark-bar-graph"></i> Reportes
                                    </button>
                                </li>
                            </ul>

                            <!-- Lista de permisos del módulo -->
                            <div id="listaPermisosModulo" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-muted text-center">Selecciona un usuario para ver sus permisos</p>
                            </div>
                        </div>

                        <!-- Mensaje inicial -->
                        <div id="mensajeInicialPermisos" class="text-center py-5 text-muted">
                            <i class="bi bi-arrow-up-circle display-4 d-block mb-3"></i>
                            <p>Selecciona un usuario del menú desplegable para gestionar sus permisos</p>
                        </div>
                    </div>
                </div>

                <!-- Card de acciones rápidas -->
                <div class="card mt-3">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Acciones Rápidas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-6 col-xl-3">
                                <button class="btn btn-outline-primary w-100" onclick="verMatrizPermisos()">
                                    <i class="bi bi-grid-3x3 me-1"></i> Ver Matriz Completa
                                </button>
                            </div>
                            <div class="col-md-6 col-xl-3">
                                <button class="btn btn-outline-secondary w-100" onclick="invalidarCachePermisos()">
                                    <i class="bi bi-arrow-repeat me-1"></i> Limpiar Cache
                                </button>
                            </div>
                            <div class="col-md-6 col-xl-3">
                                <button class="btn btn-outline-warning w-100" onclick="limpiarOverridesPermisos()">
                                    <i class="bi bi-broom me-1"></i> Limpiar Overrides
                                </button>
                            </div>
                            <div class="col-md-6 col-xl-3">
                                <button class="btn btn-outline-dark w-100" onclick="mostrarPermisosProtegidos()">
                                    <i class="bi bi-shield-lock me-1"></i> Permisos Protegidos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}{# fin tiene_permiso usr_permisos #}
    </div>

    <!-- Modal para ver matriz de permisos -->
    <div class="modal fade" id="matrizPermisosModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-grid-3x3 me-2"></i>Matriz de Permisos por Rol</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="contenidoMatrizPermisos">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Cargando matriz de permisos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <!-- Modal: Permisos protegidos -->
    <div class="modal fade" id="permisosProtegidosModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Permisos protegidos (Admin)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-2" style="font-size: 0.9rem;">
                        Estos permisos no se pueden quitar a usuarios con rol <strong>admin</strong>.
                    </p>
                    <ul id="listaPermisosProtegidos" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


    <!-- ============================================
         JAVASCRIPT PARA GESTIÓN DE PERMISOS
         Carga permisos específicos
         ============================================ -->
    <script>
    // Variables globales para permisos
    var permisosUsuarioActual = {};
    var usuarioSeleccionado = null;
    var usuarioIdSeleccionado = null;
    var moduloActivo = 'simulador';

    // Descripciones de permisos
    var descripcionesPermisos = {
        'sim_usar': 'Usar simulador interno',
        'sim_hist_propio': 'Ver historial propio',
        'sim_hist_equipo': 'Ver historial del equipo',
        'sim_hist_todos': 'Ver todo el historial',
        'sco_ejecutar': 'Ejecutar scoring',
        'sco_hist_propio': 'Ver historial propio',
        'sco_hist_equipo': 'Ver historial del equipo',
        'sco_hist_todos': 'Ver todo el historial',
        'com_enviar': 'Enviar casos a comité',
        'com_ver_propios': 'Ver mis casos',
        'com_ver_pendientes': 'Ver casos pendientes',
        'com_ver_todos': 'Ver todos los casos',
        'com_aprobar': 'Aprobar casos',
        'com_rechazar': 'Rechazar casos',
        'com_marcar_desembolso': 'Marcar como desembolsado',
        'com_marcar_desistido': 'Marcar como desistido',
        'cfg_sco_ver': 'Ver config scoring',
        'cfg_sco_editar': 'Editar config scoring',
        'cfg_tasas_ver': 'Ver tasas y costos',
        'cfg_tasas_editar': 'Editar tasas y costos',
        'cfg_params_ver': 'Ver parámetros',
        'cfg_params_editar': 'Editar parámetros',
        'cfg_comite_ver': 'Ver config comité',
        'cfg_comite_editar': 'Editar config comité',
        'usr_ver': 'Ver lista de usuarios',
        'usr_crear': 'Crear usuarios',
        'usr_editar': 'Editar usuarios',
        'usr_eliminar': 'Eliminar usuarios',
        'usr_password': 'Cambiar contraseñas',
        'usr_permisos': 'Gestionar permisos',
        'rep_metricas_propio': 'Ver métricas propias',
        'rep_metricas_equipo': 'Ver métricas del equipo',
        'rep_metricas_global': 'Ver métricas globales',
        'rep_exportar': 'Exportar datos',
        'rep_dashboard': 'Dashboard ejecutivo',
        'aud_ver_propio': 'Ver logs propios',
        'aud_ver_equipo': 'Ver logs del equipo',
        'aud_ver_todos': 'Ver todos los logs',
        'cap_usar': 'Usar capacidad de pago',
        'admin_panel_acceso': 'Acceso al panel admin',
        'usr_asignaciones_equipo': 'Gestionar asignaciones de equipo'
    };

    // Permisos por módulo
    var permisosPorModulo = {
        'simulador': ['sim_usar', 'cap_usar', 'sim_hist_propio', 'sim_hist_equipo', 'sim_hist_todos'],
        'scoring': ['sco_ejecutar', 'sco_hist_propio', 'sco_hist_equipo', 'sco_hist_todos'],
        'comite': ['com_enviar', 'com_ver_propios', 'com_ver_pendientes', 'com_ver_todos', 'com_aprobar', 'com_rechazar', 'com_marcar_desembolso', 'com_marcar_desistido'],
        'config': ['cfg_sco_ver', 'cfg_sco_editar', 'cfg_tasas_ver', 'cfg_tasas_editar', 'cfg_params_ver', 'cfg_params_editar', 'cfg_comite_ver', 'cfg_comite_editar'],
        'usuarios': ['usr_ver', 'usr_crear', 'usr_editar', 'usr_eliminar', 'usr_password', 'usr_permisos', 'usr_asignaciones_equipo'],
        'reportes': ['rep_metricas_propio', 'rep_metricas_equipo', 'rep_metricas_global', 'rep_exportar', 'rep_dashboard', 'aud_ver_propio', 'aud_ver_equipo', 'aud_ver_todos']
    };

    // Cargar estadísticas de permisos
    function cargarEstadisticasPermisos() {
        fetch('/api/permisos/matriz', { headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.permisos) document.getElementById('totalPermisos').textContent = data.permisos.length;
            if (data.matriz) {
                document.getElementById('permisosAsesor').textContent = Object.values(data.matriz.asesor || {}).filter(function(v){return v;}).length;
                document.getElementById('permisosSupervisor').textContent = Object.values(data.matriz.supervisor || {}).filter(function(v){return v;}).length;
                document.getElementById('permisosAuditor').textContent = Object.values(data.matriz.auditor || {}).filter(function(v){return v;}).length;
                document.getElementById('permisosGerente').textContent = Object.values(data.matriz.gerente || {}).filter(function(v){return v;}).length;
                document.getElementById('permisosAdminTecnico').textContent = Object.values(data.matriz.admin_tecnico || {}).filter(function(v){return v;}).length;
                document.getElementById('permisosComite').textContent = Object.values(data.matriz.comite_credito || {}).filter(function(v){return v;}).length;
            }
        }).catch(function(e) { console.error('Error cargando estadísticas:', e); });
    }

    // Botón Actualizar - recarga desde BD
    function cargarPermisosUsuarios() {
        if (usuarioIdSeleccionado) {
            cargarPermisosDetalleReal(usuarioIdSeleccionado);
        } else if (usuarioSeleccionado) {
            cargarPermisosUsuario(usuarioSeleccionado);
        } else {
            alert('Selecciona un usuario primero');
        }
    }

    // Cargar permisos de un usuario (desde selector)
    function cargarPermisosUsuario(username) {
        if (!username) {
            document.getElementById('contenedorPermisosUsuario').style.display = 'none';
            document.getElementById('mensajeInicialPermisos').style.display = 'block';
            return;
        }

        usuarioSeleccionado = username;
        var select = document.getElementById('selectorUsuarioPermisos');
        var option = select.options[select.selectedIndex];
        var rol = option.dataset.rol;
        var nombreCompleto = option.text.split('(')[0].trim();

        document.getElementById('nombreUsuarioSeleccionado').textContent = nombreCompleto;
        document.getElementById('rolUsuarioSeleccionado').textContent = rol;
        document.getElementById('contenedorPermisosUsuario').style.display = 'block';
        document.getElementById('mensajeInicialPermisos').style.display = 'none';

        // Primero obtener el ID del usuario
        fetch('/api/usuarios/' + username + '/id', { headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success && data.id) {
                usuarioIdSeleccionado = data.id;
                // Ahora cargar permisos reales desde la BD
                cargarPermisosDetalleReal(data.id);
            } else {
                console.error('No se pudo obtener ID del usuario');
                // Fallback: usar matriz general
                cargarPermisosDetalleFallback(username, rol);
            }
        })
        .catch(function(e) {
            console.error('Error obteniendo ID:', e);
            cargarPermisosDetalleFallback(username, rol);
        });
    }

    // Cargar detalle REAL de permisos desde /api/permisos/usuario/{id}
    function cargarPermisosDetalleReal(userId) {
        fetch('/api/permisos/usuario/' + userId, { headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                console.error('Error del API:', data.error);
                return;
            }

            // Construir mapa de permisos del rol (true/false por código)
            var permisosRolMap = {};

            // Primero, obtener matriz para saber qué permisos tiene el rol base
            fetch('/api/permisos/matriz', { headers: { 'X-CSRFToken': getCSRFToken() } })
            .then(function(r2) { return r2.json(); })
            .then(function(matriz) {
                if (matriz.matriz && matriz.matriz[data.rol]) {
                    permisosRolMap = matriz.matriz[data.rol];
                }

                // Guardar estado con permisos específicos REALES de la BD
                permisosUsuarioActual = {
                    rol: data.rol,
                    permisos_rol: permisosRolMap,
                    permisos_agregados: data.permisos_agregados || [],
                    permisos_quitados: data.permisos_quitados || [],
                    permisos_quitados_sin_efecto: data.permisos_quitados_sin_efecto || [],
                    permisos_protegidos: data.permisos_protegidos || []
                };

                console.log('✅ Permisos cargados:', {
                    rol: data.rol,
                    agregados: data.permisos_agregados,
                    quitados: data.permisos_quitados
                });

                renderizarModuloPermisos(moduloActivo);
            });
        })
        .catch(function(e) {
            console.error('Error cargando permisos:', e);
        });
    }

    // Fallback: usar matriz general (cuando no se puede obtener ID)
    function cargarPermisosDetalleFallback(username, rol) {
        fetch('/api/permisos/matriz', { headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.matriz && data.matriz[rol]) {
                permisosUsuarioActual = {
                    rol: rol,
                    permisos_rol: data.matriz[rol],
                    permisos_agregados: [],
                    permisos_quitados: []
                };
                renderizarModuloPermisos(moduloActivo);
            }
        }).catch(function(e) { console.error('Error:', e); });
    }

    // Cambiar módulo (tabs)
    function mostrarModuloPermisos(modulo) {
        moduloActivo = modulo;
        var tabs = document.querySelectorAll('#modulosPermisosTabs .nav-link');
        var moduloMap = {'simulador':'Simulador','scoring':'Scoring','comite':'Comité','config':'Config','usuarios':'Usuarios','reportes':'Reportes'};
        tabs.forEach(function(btn) {
            btn.classList.remove('active');
            if (btn.textContent.trim().indexOf(moduloMap[modulo]) !== -1) btn.classList.add('active');
        });
        renderizarModuloPermisos(modulo);
    }

    // Renderizar permisos del módulo actual
    function renderizarModuloPermisos(modulo) {
        var container = document.getElementById('listaPermisosModulo');
        var permisos = permisosPorModulo[modulo] || [];

        if (!usuarioSeleccionado || !permisosUsuarioActual.permisos_rol) {
            container.innerHTML = '<p class="text-muted text-center">Selecciona un usuario primero</p>';
            return;
        }

        var html = '<div class="list-group">';
        permisos.forEach(function(codigo) {
            // Verificar estado real del permiso
            var tienePermisoRol = permisosUsuarioActual.permisos_rol[codigo] || false;
            var esAgregado = permisosUsuarioActual.permisos_agregados.indexOf(codigo) !== -1;
            var esQuitado = permisosUsuarioActual.permisos_quitados.indexOf(codigo) !== -1;
            var esQuitadoSinEfecto = (permisosUsuarioActual.permisos_quitados_sin_efecto || []).indexOf(codigo) !== -1;
            var esProtegido = (permisosUsuarioActual.permisos_protegidos || []).indexOf(codigo) !== -1;

            // Determinar estado efectivo (quitado sin efecto NO bloquea)
            var tienePermisoEfectivo = (tienePermisoRol || esAgregado) && !esQuitado;

            var estadoIcon = '', estadoClass = '', estadoTexto = '';

            if (esAgregado) {
                estadoIcon = '<i class="bi bi-plus-circle-fill text-primary"></i>';
                estadoClass = 'border-primary border-2';
                estadoTexto = '<small class="text-primary ms-1">(agregado)</small>';
            } else if (esQuitado) {
                estadoIcon = '<i class="bi bi-dash-circle-fill text-danger"></i>';
                estadoClass = 'border-danger border-2';
                estadoTexto = '<small class="text-danger ms-1">(quitado)</small>';
            } else if (esQuitadoSinEfecto) {
                estadoIcon = '<i class="bi bi-exclamation-triangle-fill text-warning"></i>';
                estadoClass = 'border-warning border-2';
                estadoTexto = '<small class="text-warning ms-1">(quitado sin efecto)</small>';
            } else if (tienePermisoRol) {
                estadoIcon = '<i class="bi bi-check-circle-fill text-success"></i>';
                estadoTexto = '<small class="text-muted ms-1">(del rol)</small>';
            } else {
                estadoIcon = '<i class="bi bi-x-circle text-muted"></i>';
                estadoClass = 'opacity-50';
                estadoTexto = '';
            }

            // Botones de acción según estado REAL
            var botones = '';

            if (esQuitado) {
                // Si está quitado, mostrar botón para restaurar
                botones += '<button class="btn btn-outline-success btn-sm" onclick="restaurarPermiso(\'' + codigo + '\')" title="Restaurar permiso"><i class="bi bi-arrow-counterclockwise"></i> Restaurar</button>';
            } else if (esAgregado) {
                // Si está agregado, mostrar botón para restaurar (quitar el agregado)
                botones += '<button class="btn btn-outline-secondary btn-sm" onclick="restaurarPermiso(\'' + codigo + '\')" title="Restaurar al valor del rol"><i class="bi bi-arrow-counterclockwise"></i> Restaurar</button>';
            } else if (esQuitadoSinEfecto) {
                // Override inútil: se puede limpiar
                botones += '<button class="btn btn-outline-warning btn-sm" onclick="restaurarPermiso(\'' + codigo + '\')" title="Limpiar override sin efecto"><i class="bi bi-broom"></i> Limpiar</button>';
            } else if (tienePermisoRol) {
                // Si viene del rol y no está modificado, permitir quitar (excepto protegidos en admin)
                if (permisosUsuarioActual.rol === 'admin' && esProtegido) {
                    botones += '<button class="btn btn-outline-secondary btn-sm" disabled title="Permiso protegido en admin"><i class="bi bi-shield-lock"></i> Protegido</button>';
                } else {
                    botones += '<button class="btn btn-outline-danger btn-sm" onclick="quitarPermiso(\'' + codigo + '\')" title="Quitar permiso"><i class="bi bi-dash"></i> Quitar</button>';
                }
            } else {
                // Si no tiene el permiso, permitir agregar
                botones += '<button class="btn btn-outline-primary btn-sm" onclick="agregarPermiso(\'' + codigo + '\')" title="Agregar permiso"><i class="bi bi-plus"></i> Agregar</button>';
            }

            html += '<div class="list-group-item d-flex justify-content-between align-items-center ' + estadoClass + '">';
            html += '<div>' + estadoIcon;
            html += '<span class="ms-2">' + (descripcionesPermisos[codigo] || codigo) + '</span>';
            html += estadoTexto;
            html += '<small class="text-muted ms-2">(' + codigo + ')</small>';
            html += '</div>';
            html += '<div class="btn-group btn-group-sm">' + botones + '</div>';
            html += '</div>';
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // Agregar permiso
    function agregarPermiso(codigo) {
        if (!usuarioIdSeleccionado) {
            alert('Error: No se ha seleccionado un usuario válido');
            return;
        }

        var motivo = prompt('Motivo para agregar este permiso (opcional):');
        if (motivo === null) return;

        fetch('/api/permisos/usuario/' + usuarioIdSeleccionado + '/agregar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ permiso: codigo, motivo: motivo || 'Agregado desde admin' })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('✅ Permiso agregado correctamente');
                // Recargar permisos reales desde BD
                cargarPermisosDetalleReal(usuarioIdSeleccionado);
            } else {
                alert('❌ Error: ' + (data.message || data.error || 'Error desconocido'));
            }
        })
        .catch(function(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        });
    }

    // Quitar permiso
    function quitarPermiso(codigo) {
        if (!usuarioIdSeleccionado) {
            alert('Error: No se ha seleccionado un usuario válido');
            return;
        }

        // Verificar si ya está quitado
        if (permisosUsuarioActual.permisos_quitados.indexOf(codigo) !== -1) {
            alert('Este permiso ya está quitado. Usa "Restaurar" para devolverlo.');
            return;
        }

        var motivo = prompt('Motivo para quitar este permiso (opcional):');
        if (motivo === null) return;

        fetch('/api/permisos/usuario/' + usuarioIdSeleccionado + '/quitar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ permiso: codigo, motivo: motivo || 'Quitado desde admin' })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('✅ Permiso quitado correctamente');
                // Recargar permisos reales desde BD
                cargarPermisosDetalleReal(usuarioIdSeleccionado);
            } else {
                alert('❌ Error: ' + (data.message || data.error || 'Error desconocido'));
            }
        })
        .catch(function(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        });
    }

    // Restaurar permiso al valor del rol
    function restaurarPermiso(codigo) {
        if (!usuarioIdSeleccionado) {
            alert('Error: No se ha seleccionado un usuario válido');
            return;
        }

        fetch('/api/permisos/usuario/' + usuarioIdSeleccionado + '/restaurar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ permiso: codigo })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('✅ Permiso restaurado al valor del rol');
                // Recargar permisos reales desde BD
                cargarPermisosDetalleReal(usuarioIdSeleccionado);
            } else {
                alert('❌ Error: ' + (data.message || data.error || 'Error desconocido'));
            }
        })
        .catch(function(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        });
    }

    // Ver matriz completa
    function verMatrizPermisos() {
        var modal = new bootstrap.Modal(document.getElementById('matrizPermisosModal'));
        modal.show();
        var container = document.getElementById('contenidoMatrizPermisos');
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border"></div><p>Cargando...</p></div>';

        fetch('/api/permisos/matriz', { headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var roles = data.roles || [];
            var permisos = data.permisos || [];
            var matriz = data.matriz || {};

            var html = '<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-dark"><tr><th>Permiso</th>';
            roles.forEach(function(rol) {
                html += '<th class="text-center" style="font-size:0.65rem;">' + rol.replace('_',' ') + '</th>';
            });
            html += '</tr></thead><tbody>';

            var modActual = '';
            permisos.forEach(function(p) {
                if (p.modulo !== modActual) {
                    modActual = p.modulo;
                    html += '<tr class="table-secondary"><td colspan="' + (roles.length + 1) + '"><strong>' + modActual.toUpperCase() + '</strong></td></tr>';
                }
                html += '<tr><td style="font-size:0.75rem;">' + p.nombre + '</td>';
                roles.forEach(function(rol) {
                    var tiene = matriz[rol] && matriz[rol][p.codigo];
                    html += '<td class="text-center">' + (tiene ? '<i class="bi bi-check text-success"></i>' : '<i class="bi bi-x text-muted"></i>') + '</td>';
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        })
        .catch(function(e) {
            container.innerHTML = '<div class="alert alert-danger">Error cargando matriz</div>';
        });
    }

    // Limpiar cache
    function invalidarCachePermisos() {
        if (!confirm('¿Limpiar cache de permisos?\n\nEsto forzará al sistema a recargar todos los permisos desde la base de datos.')) return;

        fetch('/api/permisos/cache/invalidar', { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('✅ Cache de permisos limpiado correctamente.\n\nLos usuarios necesitan cerrar sesión y volver a entrar para ver los cambios.');
                cargarEstadisticasPermisos();
                if (usuarioIdSeleccionado) {
                    cargarPermisosDetalleReal(usuarioIdSeleccionado);
                }
            } else {
                alert('❌ Error: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(function(e) { alert('Error de conexión'); });
    }

    // Limpiar overrides sin efecto (permisos protegidos quitados a admin)
    function limpiarOverridesPermisos() {
        if (!confirm('¿Limpiar overrides sin efecto?\n\nEsto eliminará de la base de datos los overrides inútiles (por ejemplo, permisos protegidos quitados a usuarios admin).')) return;

        fetch('/api/permisos/limpiar-overrides', { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('✅ Overrides limpiados.\n\nEliminados: ' + (data.eliminados || 0));
                cargarEstadisticasPermisos();
                if (usuarioIdSeleccionado) cargarPermisosDetalleReal(usuarioIdSeleccionado);
            } else {
                alert('❌ Error: ' + (data.message || data.error || 'Error desconocido'));
            }
        })
        .catch(function(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        });
    }

    // Mostrar permisos protegidos (lista informativa)
    function mostrarPermisosProtegidos() {
        fetch('/api/permisos/protegidos', { headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var lista = document.getElementById('listaPermisosProtegidos');
            if (!lista) return;

            var items = data.permisos_protegidos || [];
            if (!items.length) {
                lista.innerHTML = '<li class="list-group-item text-muted">No hay permisos protegidos.</li>';
            } else {
                lista.innerHTML = items.map(function(c) {
                    var desc = descripcionesPermisos[c] || c;
                    return '<li class="list-group-item d-flex justify-content-between align-items-center">' +
                        '<span>' + desc + '<small class="text-muted ms-2">(' + c + ')</small></span>' +
                        '<span class="badge bg-secondary">protegido</span>' +
                    '</li>';
                }).join('');
            }

            var modal = new bootstrap.Modal(document.getElementById('permisosProtegidosModal'));
            modal.show();
        })
        .catch(function(e) {
            console.error('Error:', e);
            alert('Error cargando permisos protegidos');
        });
    }

    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('Permisos')) {
            setTimeout(cargarEstadisticasPermisos, 500);
        }
    });
    </script>

    <script>
 // ============================================
    // 🎯 SECCIÓN 1: SISTEMA DE TABS - IMPLEMENTACIÓN ROBUSTA
    // ============================================

    // 1.1 Función principal para cambiar tabs con validación exhaustiva
    function openTab(evt, tabName) {
        console.log('✅ openTab ejecutado:', tabName);

        // ✅ VALIDACIÓN: Verificar que el tab existe en el DOM
        var selectedTab = document.getElementById(tabName);
        if (!selectedTab) {
            console.error('❌ Tab no encontrado en DOM:', tabName);
            console.error('❌ Tabs disponibles:', Array.from(document.querySelectorAll('.tabcontent')).map(t => t.id));
            alert('Error: Pestaña "' + tabName + '" no encontrada. Contacte al administrador.');
            return false;
        }

        try {
            // Ocultar TODOS los contenidos
            var tabcontents = document.getElementsByClassName("tabcontent");
            console.log('🔍 Total tabs encontrados:', tabcontents.length);

            for (var i = 0; i < tabcontents.length; i++) {
                tabcontents[i].style.display = "none";
                tabcontents[i].classList.remove('active');
            }

            // Remover clase active de TODOS los botones
            var tablinks = document.getElementsByClassName("tablinks");
            for (var i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            // Mostrar el tab seleccionado con múltiples verificaciones
            selectedTab.style.display = "block";
            selectedTab.style.visibility = "visible";
            selectedTab.style.opacity = "1";
            selectedTab.classList.add('active');

            // ✅ VERIFICACIÓN: Asegurar que el contenido es visible
            var computedStyle = window.getComputedStyle(selectedTab);
            console.log('🔍 Tab display después de activar:', computedStyle.display);
            console.log('🔍 Tab visibility después de activar:', computedStyle.visibility);

            if (computedStyle.display === 'none') {
                console.error('⚠️ ADVERTENCIA: El tab sigue oculto después de activarlo');
                // Forzar visualización
                selectedTab.style.setProperty('display', 'block', 'important');
            }

            // Activar el botón correspondiente
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            }

            // Guardar estado
            window.location.hash = tabName;
            sessionStorage.setItem('activeTab', tabName);

            console.log('✅ Tab activado exitosamente:', tabName);
            console.log('✅ Contenido del tab tiene', selectedTab.children.length, 'elementos hijos');

            // ✅ SCROLL suave hacia el tab activado (mejora UX)
            setTimeout(function() {
                selectedTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

        } catch (error) {
            console.error('❌ Error al activar tab:', error);
            alert('Error al cambiar de pestaña: ' + error.message);
        }
    }

    // 1.2 Inicialización al cargar la página con validación
    function initializeTabs() {
        console.log('🔧 Inicializando sistema de tabs...');

        try {
            // Verificar que hay tabs en el DOM
            var allTabs = document.querySelectorAll('.tabcontent');
            console.log('🔍 Tabs encontrados en DOM:', allTabs.length);

            if (allTabs.length === 0) {
                console.error('❌ CRÍTICO: No se encontraron tabs en el DOM');
                alert('Error crítico: No se pudieron cargar las pestañas del panel de administración.');
                return;
            }

            // Listar todos los IDs de tabs disponibles
            var tabIds = Array.from(allTabs).map(function(tab) { return tab.id; });
            console.log('🔍 IDs de tabs disponibles:', tabIds);

            var savedTab = sessionStorage.getItem('activeTab');
            var hashTab = window.location.hash.substr(1);
            var tabToShow = savedTab || hashTab || 'Usuarios';

            console.log('📍 Tab a mostrar:', tabToShow);

            // Verificar que el tab a mostrar existe
            var tabElement = document.getElementById(tabToShow);
            if (!tabElement) {
                console.warn('⚠️ Tab solicitado no encontrado:', tabToShow, '- usando Usuarios');
                tabToShow = 'Usuarios';
                tabElement = document.getElementById(tabToShow);

                if (!tabElement) {
                    console.error('❌ CRÍTICO: Ni siquiera el tab Usuarios existe');
                    alert('Error crítico: No se pudo cargar ninguna pestaña. Recargue la página.');
                    return;
                }
            }

            // Ocultar TODOS primero
            var tabcontents = document.getElementsByClassName("tabcontent");
            for (var i = 0; i < tabcontents.length; i++) {
                tabcontents[i].style.display = "none";
            }

            // Mostrar el tab correcto
            tabElement.style.display = "block";
            tabElement.style.visibility = "visible";
            tabElement.style.opacity = "1";

            // Activar el botón correcto
            var buttons = document.querySelectorAll('.tablinks');
            buttons.forEach(function(btn) {
                var onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(tabToShow)) {
                    btn.classList.add('active');
                }
            });

            console.log('✅ Sistema de tabs inicializado correctamente');
            console.log('✅ Tab activo:', tabToShow);

        } catch (error) {
            console.error('❌ Error en initializeTabs:', error);
            alert('Error al inicializar pestañas: ' + error.message);
        }
    }

    // 1.3 Guardar tab antes de submit de formularios
    function saveCurrentTab() {
        try {
            var activeTab = document.querySelector('.tablinks.active');
            if (activeTab) {
                var onclick = activeTab.getAttribute('onclick');
                if (onclick) {
                    var match = onclick.match(/openTab\(.*?,\s*'([^']+)'/);
                    if (match) {
                        sessionStorage.setItem('activeTab', match[1]);
                        console.log('💾 Tab guardado antes de submit:', match[1]);
                    }
                }
            }
        } catch (error) {
            console.error('Error en saveCurrentTab:', error);
        }
    }

    // 1.4 Restaurar tab después de reload
    function restoreActiveTab() {
        var savedTab = sessionStorage.getItem('activeTab');
        if (savedTab) {
            var tabElement = document.getElementById(savedTab);
            if (tabElement) {
                console.log('🔄 Restaurando tab:', savedTab);
                openTab(null, savedTab);
            }
        }
    }

    // ============================================
    // 🎯 SECCIÓN 2: HELPERS Y UTILIDADES
    // ============================================

    // 2.1 Formatear números con puntos
    function formatNumber(input) {
        let value = input.value.replace(/\./g, '');
        value = value.replace(/\D/g, '');
        value = value.replace(/^0+/, '');
        if (value) {
            input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        } else {
            input.value = '';
        }
    }

    // 2.2 Obtener token CSRF
    function getCSRFToken() {
        var tokenInput = document.querySelector('input[name="csrf_token"]');
        if (tokenInput) {
            return tokenInput.value;
        }
        var allTokens = document.querySelectorAll('input[name="csrf_token"]');
        if (allTokens.length > 0) {
            return allTokens[0].value;
        }
        console.error('❌ No se encontró token CSRF');
        return '';
    }

    // 2.3 Calcular tasa mensual desde anual
    function calcularTasaMensual(tasaAnual) {
        // Fórmula oficial Superfinanciera de Colombia
        // Conversión Tasa Efectiva Anual (E.A.) → Tasa Nominal Mensual
        // Fórmula: ((1 + Tasa_EA/100)^(1/12)) - 1
        const tasaAnualDecimal = parseFloat(tasaAnual) / 100;
        const tasaMensualDecimal = Math.pow(1 + tasaAnualDecimal, 1/12) - 1;
        const tasaMensualPorcentaje = tasaMensualDecimal * 100;
        return tasaMensualPorcentaje.toFixed(4);
    }

    // 2.4 Actualizar tasa mensual en UI
    function actualizarTasaMensual(inputId, outputId) {
        const tasaAnualInput = document.getElementById(inputId);
        const tasaMensualSpan = document.getElementById(outputId);
        const tasaAnual = tasaAnualInput.value.replace(',', '.');

        if (!isNaN(tasaAnual) && tasaAnual.trim() !== '') {
            const tasaMensual = calcularTasaMensual(tasaAnual);
            tasaMensualSpan.innerText = tasaMensual + '%';
        } else {
            tasaMensualSpan.innerText = 'Error';
        }
    }

    // ============================================
    // 🎯 SECCIÓN 3: GESTIÓN DE SCORING
    // ============================================

    // 3.1 (scoringData ya declarado al inicio del script

    // 3.2 Actualizar nivel de riesgo
    function updateNivelRiesgo(index, field, value) {
        if (field === 'min' || field === 'max') {
            value = parseFloat(value);
        }
        scoringData.niveles_riesgo[index][field] = value;
    }

    // 3.3 Actualizar tasas por nivel
    function updateNivelTasa(nivelIndex, tipoCredito, campo, valor) {
        if (!scoringData.niveles_riesgo[nivelIndex].tasas_por_producto) {
            scoringData.niveles_riesgo[nivelIndex].tasas_por_producto = {};
        }
        if (!scoringData.niveles_riesgo[nivelIndex].tasas_por_producto[tipoCredito]) {
            scoringData.niveles_riesgo[nivelIndex].tasas_por_producto[tipoCredito] = {
                tasa_anual: 0,
                tasa_mensual: 0
            };
        }
        scoringData.niveles_riesgo[nivelIndex].tasas_por_producto[tipoCredito][campo] = parseFloat(valor);

        if (campo === 'tasa_anual') {
            const tasaMensual = calcularTasaMensual(valor);
            scoringData.niveles_riesgo[nivelIndex].tasas_por_producto[tipoCredito]['tasa_mensual'] = parseFloat(tasaMensual);

            const inputs = document.querySelectorAll('.nivel-tasa-input');
            inputs.forEach(input => {
                if (input.dataset.nivelIndex == nivelIndex &&
                    input.dataset.tipo == tipoCredito &&
                    input.dataset.field == 'tasa_mensual') {
                    input.value = tasaMensual;
                }
            });
        }
    }

    // 3.4 Actualizar aval dinámico
    function updateNivelAval(nivelIndex, tipoCredito, valor) {
        if (!scoringData.niveles_riesgo[nivelIndex].aval_por_producto) {
            scoringData.niveles_riesgo[nivelIndex].aval_por_producto = {};
        }
        const avalDecimal = parseFloat(valor) / 100;
        scoringData.niveles_riesgo[nivelIndex].aval_por_producto[tipoCredito] = avalDecimal;
    }

    // Función para formatear input de aval sin problemas de "00,0"
    function formatAvalInput(input) {
        let val = input.value.replace(',', '.');
        val = parseFloat(val);
        if (isNaN(val) || val < 0) {
            val = 0;
        }
        if (val > 50) {
            val = 50;
        }
        input.value = val.toFixed(2);
    }

    // 3.5 Actualizar puntaje mínimo
    function updatePuntajeMinimo(value) {
        scoringData.puntaje_minimo_aprobacion = parseInt(value);
    }

    // 3.6 Guardar configuración completa de scoring
    function guardarConfiguracionScoring() {
        saveCurrentTab();

        // Capturar puntaje mínimo
        if (document.getElementById('puntajeMinimo')) {
            const puntajeMinimo = document.getElementById('puntajeMinimo').value;
            scoringData.puntaje_minimo_aprobacion = parseInt(puntajeMinimo);
        }

        // Incluir umbral mora telcos en scoringData
        const umbralInput = document.getElementById('umbralMoraTelcos');
        if (umbralInput) {
            const valorNum = parseFloat(umbralInput.value.replace(/,/g, '').replace('$', '')) || 200000;
            scoringData.umbral_mora_telcos_rechazo = valorNum;
        }

        // CORRECCIÓN 2025-12-26: Guardar orden de secciones
        if (scoringData.secciones && scoringData.secciones.length > 0) {
            scoringData.secciones.forEach((seccion, index) => {
                seccion.orden = index;
            });
            console.log('✅ Orden de secciones actualizado:', scoringData.secciones.length);
        }

        // Campo 'orden' a cada criterio DENTRO de su sección
        const criteriosPorSeccion = {};
        Object.entries(scoringData.criterios).forEach(([criterioId, criterio]) => {
            const seccionId = criterio.seccion || 'otros';
            if (!criteriosPorSeccion[seccionId]) {
                criteriosPorSeccion[seccionId] = [];
            }
            criteriosPorSeccion[seccionId].push({ id: criterioId, criterio });
        });

        // Asignar orden dentro de cada sección
        Object.keys(criteriosPorSeccion).forEach(seccionId => {
            criteriosPorSeccion[seccionId]
                .sort((a, b) => (a.criterio.orden || 0) - (b.criterio.orden || 0))
                .forEach((item, index) => {
                    scoringData.criterios[item.id].orden = index;
                });
        });
        console.log('✅ Campo orden agregado a criterios por sección');

        const btnGuardar = event.target;
        const textoOriginal = btnGuardar.innerHTML;
        btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
        btnGuardar.disabled = true;

        const totalPeso = Object.values(scoringData.criterios).reduce((sum, criterio) => sum + criterio.peso, 0);
        if (Math.abs(totalPeso - 100) > 0.1) {
            alert(`Error: La suma de pesos debe ser 100%. Actual: ${totalPeso}%`);
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
            return;
        }

        if (Object.keys(scoringData.criterios).length === 0) {
            alert(`Error: Debe existir al menos un criterio.`);
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
            return;
        }

        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            alert('Error: Token CSRF no encontrado.');
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
            return;
        }

        fetch('/admin/scoring/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(scoringData)
        })
        .then(response => {
            //  MANEJO DE SESIÓN EXPIRADA (CSRF)
            if (response.status === 400 || response.status === 401) {
                // Sesión expirada o token CSRF inválido
                alert('Tu sesión ha expirado. Serás redirigido al login.');
                window.location.href = '/login';
                return null; // Detener el procesamiento
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // Si sesión expiró, no continuar

            if (data.success) {
                alert('Configuración guardada correctamente.');
                // Mantener sub-tab activo después de guardar
                const activeSubTab = document.querySelector('#scoringSubTabs .nav-link.active');
                const subTabId = activeSubTab ? activeSubTab.getAttribute('data-bs-target') : '';
                sessionStorage.setItem('scoringActiveSubTab', subTabId);
                window.location.hash = 'Scoring';
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión. Verifica tu conexión a internet.');
        })
        .finally(() => {
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
        });
    }

    // 3.7 Cargar factores de rechazo (MEJORADO v2.0 - Compatible v1.0 y v2.0)
    function cargarFactoresRechazo() {
        const tbody = document.getElementById('factores-rechazo-body');
        if (!tbody) {
            console.error('❌ Elemento factores-rechazo-body no encontrado');
            return;
        }

        // ✅ VERIFICACIÓN: scoringData debe existir
        if (typeof scoringData === 'undefined') {
            console.error('❌ scoringData no está definido');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error: No se pudo cargar la configuración de scoring</td></tr>';
            return;
        }

        tbody.innerHTML = '';

        if (!scoringData.factores_rechazo_automatico || !Array.isArray(scoringData.factores_rechazo_automatico)) {
            console.warn('⚠️ No hay factores de rechazo configurados');
            scoringData.factores_rechazo_automatico = [];
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted"><i class="bi bi-info-circle me-2"></i>No hay factores de rechazo configurados. Haz clic en "Agregar Factor de Rechazo".</td></tr>';
            return;
        }

        console.log('✅ Cargando', scoringData.factores_rechazo_automatico.length, 'factores de rechazo...');

        scoringData.factores_rechazo_automatico.forEach((factor, index) => {
            // 🔄 NORMALIZACIÓN: Soportar estructura v1.0 (simple) y v2.0 (compleja)
            // v1.0: { criterio, operador, valor_limite, mensaje }
            // v2.0: { criterio, operador, valor_limite, mensaje, + propiedades extra }
            const criterioId = factor.criterio || '';
            const operador = factor.operador || '>=';
            const valorLimite = factor.valor_limite || factor.valor_minimo || 0;
            const mensaje = factor.mensaje || '';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select class="form-select form-select-sm factor-criterio" data-index="${index}">
                        ${Object.keys(scoringData.criterios).map(id => {
                            const criterio = scoringData.criterios[id];
                            const nombreMostrar = criterio.nombre || id;
                            return `<option value="${id}" ${criterioId === id ? 'selected' : ''}>${nombreMostrar}</option>`;
                        }).join('')}
                    </select>
                </td>
                <td>
                    <div class="input-group input-group-sm">
                        <select class="form-select factor-operador" data-index="${index}" style="min-width: 180px;">
                            <option value="<" ${operador === '<' ? 'selected' : ''}>< (menor que)</option>
                            <option value="<=" ${operador === '<=' ? 'selected' : ''}>&le; (menor o igual)</option>
                            <option value=">" ${operador === '>' ? 'selected' : ''}>> (mayor que)</option>
                            <option value=">=" ${operador === '>=' ? 'selected' : ''}>&ge; (mayor o igual)</option>
                            <option value="==" ${operador === '==' ? 'selected' : ''}">== (igual a)</option>
                        </select>
                        <input type="number" class="form-control factor-valor" data-index="${index}"
                               value="${valorLimite}" style="max-width: 120px;">
                    </div>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm factor-mensaje" data-index="${index}"
                           value="${mensaje}" placeholder="Mensaje de rechazo">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFactorRechazo(${index})"
                            title="Eliminar factor">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Agregar listeners para cambios
        document.querySelectorAll('.factor-criterio, .factor-operador, .factor-valor, .factor-mensaje').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                if (!scoringData.factores_rechazo_automatico[index]) {
                    scoringData.factores_rechazo_automatico[index] = {};
                }

                if (this.classList.contains('factor-criterio')) {
                    scoringData.factores_rechazo_automatico[index].criterio = this.value;
                } else if (this.classList.contains('factor-operador')) {
                    scoringData.factores_rechazo_automatico[index].operador = this.value;
                } else if (this.classList.contains('factor-valor')) {
                    const valor = parseInt(this.value) || 0;
                    scoringData.factores_rechazo_automatico[index].valor_limite = valor;
                    scoringData.factores_rechazo_automatico[index].valor_minimo = valor;
                } else if (this.classList.contains('factor-mensaje')) {
                    scoringData.factores_rechazo_automatico[index].mensaje = this.value;
                }
            });
        });

        console.log('✅ Factores de rechazo cargados exitosamente');
    }

    // 3.8 Agregar factor de rechazo
    function agregarFactorRechazo() {
        const primerCriterioId = Object.keys(scoringData.criterios)[0] || '';
        const nuevoFactor = {
            criterio: primerCriterioId,
            operador: ">=",
            valor_limite: 0,
            valor_minimo: 0,
            mensaje: "Causa de rechazo automático: {valor_actual}"
        };

        if (!scoringData.factores_rechazo_automatico) {
            scoringData.factores_rechazo_automatico = [];
        }

        scoringData.factores_rechazo_automatico.push(nuevoFactor);
        cargarFactoresRechazo();
    }

    // 3.9 Eliminar factor de rechazo
    function eliminarFactorRechazo(index) {
        if (confirm('¿Eliminar este factor de rechazo?')) {
            scoringData.factores_rechazo_automatico.splice(index, 1);
            cargarFactoresRechazo();
        }
    }

   // 🎯 SECCIÓN 4: GESTIÓN DE CRITERIOS
    // ============================================

    // (criterioRangoCounter ya declarado al inicio del script
    let opcionCounter = 0;

    function generateNewId() {
        return 'criterio_' + new Date().getTime();
    }

    function addNewCriterio() {
        document.getElementById('criterioForm').reset();
        document.getElementById('criterio_id').value = generateNewId();
        document.getElementById('isNew').value = 'true';
        document.getElementById('criterioModalLabel').textContent = 'Nuevo Criterio';
        document.getElementById('rangos_container').innerHTML = '';
        addRangoToForm();
        const modal = new bootstrap.Modal(document.getElementById('criterioModal'));
        modal.show();
    }

    function addRangoToForm(min = 0, max = 100, puntos = 0, descripcion = '') {
        const rangoId = 'rango_' + criterioRangoCounter++;
        const rangoHtml = `
            <div class="row align-items-end mb-2 rango-row" id="${rangoId}">
                <div class="col">
                    <label class="form-label">Mínimo</label>
                    <input type="number" class="form-control rango-min" value="${min}" required>
                </div>
                <div class="col">
                    <label class="form-label">Máximo</label>
                    <input type="number" class="form-control rango-max" value="${max}" required>
                </div>
                <div class="col">
                    <label class="form-label">Puntos</label>
                    <input type="number" class="form-control rango-puntos" value="${puntos}" required>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Descripción</label>
                    <div class="input-group">
                        <input type="text" class="form-control rango-descripcion" value="${descripcion}">
                        <button class="btn btn-outline-danger" type="button" onclick="removeRango('${rangoId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('rangos_container').insertAdjacentHTML('beforeend', rangoHtml);
    }

    function removeRango(rangoId) {
        const elemento = document.getElementById(rangoId);
        if (elemento) {
            elemento.remove();
        }
    }

    function toggleCampoOpciones() {
        const tipoCampo = document.getElementById('criterio_tipo').value;
        const opcionesDiv = document.getElementById('opciones_select');
        const rangoDiv = document.getElementById('rango_numerico');

        if (tipoCampo === 'select') {
            opcionesDiv.style.display = 'block';
            rangoDiv.style.display = 'none';
        } else {
            opcionesDiv.style.display = 'none';
            rangoDiv.style.display = 'block';
        }
    }

    function agregarOpcion() {
        const container = document.getElementById('opciones_container');
        const opcionId = 'opcion_' + opcionCounter++;

        const opcionHtml = `
            <div class="input-group mb-2" id="${opcionId}">
                <span class="input-group-text">Valor</span>
                <input type="text" class="form-control opcion-valor" placeholder="0">
                <span class="input-group-text">Texto</span>
                <input type="text" class="form-control opcion-texto" placeholder="Descripción">
                <button class="btn btn-outline-danger" type="button" onclick="removerOpcion('${opcionId}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', opcionHtml);
    }

    function removerOpcion(opcionId) {
        document.getElementById(opcionId).remove();
    }

    function saveCriterio() {
        const criterioId = document.getElementById('criterio_id').value;
        const isNew = document.getElementById('isNew').value === 'true';
        const nombre = document.getElementById('criterio_nombre').value;
        const peso = parseInt(document.getElementById('criterio_peso').value);
        const tipoCampo = document.getElementById('criterio_tipo').value;
        const placeholder = document.getElementById('criterio_placeholder').value;
        const ayuda = document.getElementById('criterio_ayuda').value;
        const min = document.getElementById('criterio_min').value;
        const max = document.getElementById('criterio_max').value;

        if (!nombre || isNaN(peso) || peso <= 0 || peso > 100) {
            alert('Complete todos los campos correctamente.');
            return;
        }

        const rangos = [];
        const rangoRows = document.querySelectorAll('.rango-row');

        rangoRows.forEach(row => {
            // Validar que los elementos existen antes de leer .value
            const minInput = row.querySelector('.rango-min');
            const maxInput = row.querySelector('.rango-max');
            const puntosInput = row.querySelector('.rango-puntos');
            const descripcionInput = row.querySelector('.rango-descripcion');

            // Si algún input no existe, skip este rango (criterios composite)
            if (!minInput || !maxInput || !puntosInput || !descripcionInput) {
                console.log('⚠️ Rango sin inputs completos (posible criterio composite) - omitido');
                return;
            }

            const minRango = parseInt(minInput.value);
            const maxRango = parseInt(maxInput.value);
            const puntos = parseInt(puntosInput.value);
            const descripcion = descripcionInput.value;

            if (!isNaN(minRango) && !isNaN(maxRango) && !isNaN(puntos)) {
                rangos.push({
                    min: minRango,
                    max: maxRango,
                    puntos: puntos,
                    descripcion: descripcion
                });
            }
        });

        let opciones = null;
        if (tipoCampo === 'select') {
            opciones = [];
            const opcionesInputs = document.querySelectorAll('#opciones_container .input-group');
            opcionesInputs.forEach(grupo => {
                const valor = grupo.querySelector('.opcion-valor').value;
                const texto = grupo.querySelector('.opcion-texto').value;
                if (valor && texto) {
                    opciones.push({ valor: valor, texto: texto });
                }
            });
        }

        const criterioCompleto = {
            nombre: nombre,
            peso: peso,
            tipo_campo: tipoCampo,
            placeholder: placeholder,
            ayuda: ayuda,
            rangos: rangos
        };

        if (tipoCampo === 'number' || tipoCampo === 'currency' || tipoCampo === 'percentage') {
            if (min) criterioCompleto.min = parseInt(min);
            if (max) criterioCompleto.max = parseInt(max);
        }

        if (tipoCampo === 'select' && opciones) {
            criterioCompleto.opciones = opciones;
        }

        if (isNew) {
            scoringData.criterios[criterioId] = criterioCompleto;
        } else {
            Object.assign(scoringData.criterios[criterioId], criterioCompleto);
        }

        const totalPeso = Object.values(scoringData.criterios).reduce((sum, criterio) => sum + criterio.peso, 0);
        if (totalPeso !== 100) {
            alert(`Atención: Los pesos suman ${totalPeso}%, deberían sumar 100%.`);
        }

        bootstrap.Modal.getInstance(document.getElementById('criterioModal')).hide();
        updateCriteriosList();
        alert('Criterio guardado. Recuerde guardar la configuración.');
    }

    function editCriterio(criterioId) {
        const criterio = scoringData.criterios[criterioId];

        document.getElementById('criterioForm').reset();
        document.getElementById('criterio_id').value = criterioId;
        document.getElementById('isNew').value = 'false';
        document.getElementById('criterio_nombre').value = criterio.nombre;
        document.getElementById('criterio_peso').value = criterio.peso;
        document.getElementById('criterio_tipo').value = criterio.tipo_campo || 'number';
        document.getElementById('criterio_placeholder').value = criterio.placeholder || '';
        document.getElementById('criterio_ayuda').value = criterio.ayuda || '';
        document.getElementById('criterio_min').value = criterio.min || '';
        document.getElementById('criterio_max').value = criterio.max || '';

        toggleCampoOpciones();

        if (criterio.tipo_campo === 'select' && criterio.opciones) {
            document.getElementById('opciones_container').innerHTML = '';
            criterio.opciones.forEach(opcion => {
                agregarOpcion();
                const ultimoGrupo = document.querySelector('#opciones_container .input-group:last-child');
                ultimoGrupo.querySelector('.opcion-valor').value = opcion.valor;
                ultimoGrupo.querySelector('.opcion-texto').value = opcion.texto;
            });
        }

        document.getElementById('criterioModalLabel').textContent = 'Editar Criterio';

        document.getElementById('rangos_container').innerHTML = '';
        // Cargar rangos solo si existen (criterios normales)
        if (criterio.rangos && Array.isArray(criterio.rangos)) {
            criterio.rangos.forEach((rango, index) => {
                addRangoToForm(rango.min, rango.max, rango.puntos, rango.descripcion);
            });
        } else if (criterio.tipo_campo === 'composite') {
            // Criterios composite: mostrar mensaje informativo
            console.log('📊 Criterio composite - rangos configurados automáticamente');
        }

        const modal = new bootstrap.Modal(document.getElementById('criterioModal'));
        modal.show();
    }

    function deleteCriterio(criterioId) {
        document.getElementById('criterio_eliminar_id').value = criterioId;
        const modal = new bootstrap.Modal(document.getElementById('deleteCriterioModal'));
        modal.show();
    }

    function confirmDeleteCriterio() {
        const criterioId = document.getElementById('criterio_eliminar_id').value;
        delete scoringData.criterios[criterioId];
        bootstrap.Modal.getInstance(document.getElementById('deleteCriterioModal')).hide();

        const totalPeso = Object.values(scoringData.criterios).reduce((sum, criterio) => sum + criterio.peso, 0);
        if (totalPeso !== 100) {
            alert(`Atención: Los pesos suman ${totalPeso}%. Debe ajustar.`);
        }

        updateCriteriosList();
        alert('Criterio eliminado. Recuerde guardar la configuración.');
    }

    // ============================================
    // 🎯 SISTEMA DE SECCIONES Y CRITERIOS (2025-12-26)
    // ============================================

    function updateCriteriosList() {
        // Renderizar en el contenedor de secciones
        const seccionesContainer = document.getElementById('secciones-container');
        if (!seccionesContainer) {
            console.warn('⚠️ No se encontró secciones-container');
            return;
        }

        seccionesContainer.innerHTML = '';

        // Ordenar secciones por campo 'orden'
        const secciones = (scoringData.secciones || []).sort((a, b) => (a.orden || 0) - (b.orden || 0));

        // Agrupar criterios por sección
        const criteriosPorSeccion = {};
        Object.entries(scoringData.criterios).forEach(([criterioId, criterio]) => {
            const seccionId = criterio.seccion || 'otros';
            if (!criteriosPorSeccion[seccionId]) {
                criteriosPorSeccion[seccionId] = [];
            }
            criteriosPorSeccion[seccionId].push({ id: criterioId, ...criterio });
        });

        // Ordenar criterios dentro de cada sección por 'orden'
        Object.keys(criteriosPorSeccion).forEach(seccionId => {
            criteriosPorSeccion[seccionId].sort((a, b) => (a.orden || 0) - (b.orden || 0));
        });

        // Renderizar cada sección
        secciones.forEach((seccion, seccionIndex) => {
            const criteriosDeSeccion = criteriosPorSeccion[seccion.id] || [];
            const seccionHTML = generarSeccionHTML(seccion, criteriosDeSeccion, seccionIndex);
            seccionesContainer.insertAdjacentHTML('beforeend', seccionHTML);
        });

        console.log('✅ Secciones renderizadas:', secciones.length);

        // Restaurar estado colapsado de secciones (2025-12-26)
        const colapsadas = JSON.parse(localStorage.getItem('seccionesColapsadas') || '[]');
        colapsadas.forEach(seccionId => {
            const seccionEl = document.getElementById(`seccion-${seccionId}`);
            const chevron = document.getElementById(`chevron-${seccionId}`);
            if (seccionEl) {
                seccionEl.classList.add('collapsed');
                if (chevron) {
                    chevron.classList.remove('bi-chevron-up');
                    chevron.classList.add('bi-chevron-down');
                }
            }
        });
    }

    function generarSeccionHTML(seccion, criterios, seccionIndex) {
        const colorClass = `seccion-color-${seccion.color || 'gray'}`;
        const iconoClass = seccion.icono || 'bi-folder';

        let criteriosHTML = '';
        if (criterios.length === 0) {
            criteriosHTML = `
                <div class="criterios-seccion-empty">
                    <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                    No hay criterios en esta sección.<br>
                    <small>Arrastra criterios aquí o usa el botón + para agregar.</small>
                </div>
            `;
        } else {
            criteriosHTML = criterios.map((criterio, index) => generarCriterioHTML(criterio.id, criterio, seccion.id)).join('');
        }

        return `
            <div class="criterios-seccion" id="seccion-${seccion.id}"
                 data-seccion-id="${seccion.id}"
                 ondragover="handleSeccionDragOver(event)"
                 ondrop="handleSeccionDrop(event, '${seccion.id}')">
                <div class="criterios-seccion-header ${colorClass}">
                    <h5>
                        <i class="bi ${iconoClass} me-2"></i>
                        ${seccion.nombre}
                        <span class="badge seccion-count-badge ms-2">${criterios.length}</span>
                    </h5>
                    <div class="seccion-actions">
                        <button type="button" class="btn btn-sm btn-light"
                                onclick="agregarCriterioASeccion('${seccion.id}')"
                                title="Agregar criterio a esta sección">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-light"
                                onclick="editarSeccion('${seccion.id}')"
                                title="Editar sección">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ${seccion.id !== 'otros' ? `
                        <button type="button" class="btn btn-sm btn-light"
                                onclick="eliminarSeccion('${seccion.id}')"
                                title="Eliminar sección">
                            <i class="bi bi-trash"></i>
                        </button>
                        ` : ''}
                        <button type="button" class="btn btn-sm btn-light"
                                onclick="moverSeccionArriba('${seccion.id}')"
                                title="Mover sección arriba">
                            <i class="bi bi-arrow-up-short"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-light"
                                onclick="moverSeccionAbajo('${seccion.id}')"
                                title="Mover sección abajo">
                            <i class="bi bi-arrow-down-short"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-light"
                                onclick="toggleSeccion('${seccion.id}')"
                                title="Expandir/Colapsar">
                            <i class="bi bi-chevron-up" id="chevron-${seccion.id}"></i>
                        </button>
                    </div>
                </div>
                <div class="criterios-seccion-body" id="body-${seccion.id}"
                     ondragover="handleCriterioDragOverBody(event)"
                     ondragenter="handleCriterioDragEnterBody(event, '${seccion.id}')"
                     ondragleave="handleCriterioDragLeaveBody(event)"
                     ondrop="handleCriterioDropInSeccion(event, '${seccion.id}')">
                    ${criteriosHTML}
                </div>
            </div>
        `;
    }

    function generarCriterioHTML(criterioId, criterio, seccionId) {
        const isComposite = criterio.tipo_campo === 'composite';
        let rangosHTML = generarRangosHTML(criterioId, criterio, isComposite);

        return `
            <div class="scoring-criteria-row mb-3" id="criterio-${criterioId}"
                 draggable="true"
                 data-criterio-id="${criterioId}"
                 data-seccion="${seccionId}"
                 ondragstart="handleDragStart(event, '${criterioId}')"
                 ondragover="handleDragOver(event)"
                 ondragenter="handleDragEnter(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, '${criterioId}')"
                 ondragend="handleDragEnd(event)"
                 ontouchstart="handleTouchStart(event, '${criterioId}')"
                 ontouchmove="handleTouchMove(event)"
                 ontouchend="handleTouchEnd(event)">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <span class="drag-handle me-2" title="Arrastrar para reordenar">
                            <i class="bi bi-grip-vertical fs-5"></i>
                        </span>
                        <span class="badge badge-peso me-2">${criterio.peso}%</span>
                        <h6 class="mb-0">${criterio.nombre}</h6>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-primary btn-sm me-1"
                                onclick="editCriterio('${criterioId}')" title="Editar criterio">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm"
                                onclick="deleteCriterio('${criterioId}')" title="Eliminar criterio">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>MÍNIMO</th>
                                <th>MÁXIMO</th>
                                <th>PUNTOS</th>
                                <th>DESCRIPCIÓN</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rangosHTML}
                        </tbody>
                    </table>
                </div>

                ${!isComposite ? `
                <div class="text-end">
                    <button type="button" class="btn btn-success btn-sm"
                            onclick="editCriterio('${criterioId}')">
                        <i class="bi bi-plus-circle"></i> Añadir Rango
                    </button>
                </div>
                ` : ''}
            </div>
        `;
    }

    function generarRangosHTML(criterioId, criterio, isComposite) {
        if (!criterio.rangos || criterio.rangos.length === 0) {
            return `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        <i class="bi bi-inbox me-2"></i>No hay rangos configurados.
                        <button type="button" class="btn btn-sm btn-link"
                                onclick="editCriterio('${criterioId}')">
                            ${isComposite ? 'Ver Configuración' : 'Agregar rangos'}
                        </button>
                    </td>
                </tr>
            `;
        }

        if (isComposite) {
            return criterio.rangos.map((rango, index) => `
                <tr>
                    <td colspan="2">
                        <span class="badge bg-secondary">${rango.condicion || 'condición_auto'}</span>
                    </td>
                    <td>
                        <span class="badge ${rango.puntos >= 20 ? 'bg-success' : rango.puntos >= 10 ? 'bg-info' : rango.puntos >= 0 ? 'bg-secondary' : 'bg-danger'}">
                            ${rango.puntos} pts
                        </span>
                    </td>
                    <td>
                        ${rango.descripcion.includes('⚠️') || rango.descripcion.includes('ALERTA') ? '<i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>' : ''}
                        ${rango.descripcion.includes('🚨') ? '<i class="bi bi-exclamation-circle-fill text-danger me-1"></i>' : ''}
                        ${rango.descripcion}
                    </td>
                    <td class="text-center">
                        <span class="badge bg-primary" title="Rango calculado automáticamente">
                            <i class="bi bi-calculator"></i> Auto
                        </span>
                    </td>
                </tr>
            `).join('');
        } else {
            return criterio.rangos.map((rango, index) => `
                <tr>
                    <td><strong>${rango.min}</strong></td>
                    <td><strong>${rango.max}</strong></td>
                    <td>
                        <span class="badge ${rango.puntos >= 20 ? 'bg-success' : rango.puntos >= 10 ? 'bg-info' : rango.puntos >= 0 ? 'bg-secondary' : 'bg-danger'}">
                            ${rango.puntos} pts
                        </span>
                    </td>
                    <td>${rango.descripcion}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary"
                                    onclick="editRango('${criterioId}', ${index})"
                                    title="Editar rango">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger"
                                    onclick="deleteRango('${criterioId}', ${index})"
                                    title="Eliminar rango">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // ============================================
    // 🎯 FUNCIONES DE SECCIONES
    // ============================================

    function toggleSeccion(seccionId) {
        const seccion = document.getElementById(`seccion-${seccionId}`);
        const chevron = document.getElementById(`chevron-${seccionId}`);

        if (seccion) {
            if (seccion.classList.contains('collapsed')) {
                // Expandir
                seccion.classList.remove('collapsed');
                if (chevron) {
                    chevron.classList.remove('bi-chevron-down');
                    chevron.classList.add('bi-chevron-up');
                }
                // Quitar de colapsadas
                let colapsadas = JSON.parse(localStorage.getItem('seccionesColapsadas') || '[]');
                colapsadas = colapsadas.filter(id => id !== seccionId);
                localStorage.setItem('seccionesColapsadas', JSON.stringify(colapsadas));
            } else {
                // Colapsar
                seccion.classList.add('collapsed');
                if (chevron) {
                    chevron.classList.remove('bi-chevron-up');
                    chevron.classList.add('bi-chevron-down');
                }
                // Agregar a colapsadas
                let colapsadas = JSON.parse(localStorage.getItem('seccionesColapsadas') || '[]');
                if (!colapsadas.includes(seccionId)) {
                    colapsadas.push(seccionId);
                }
                localStorage.setItem('seccionesColapsadas', JSON.stringify(colapsadas));
            }
        }
    }

    function mostrarModalSeccion(seccionId = null) {
        const modal = new bootstrap.Modal(document.getElementById('seccionModal'));
        const titulo = document.getElementById('seccionModalLabel');

        if (seccionId) {
            // Editar sección existente
            const seccion = scoringData.secciones.find(s => s.id === seccionId);
            if (seccion) {
                titulo.innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Sección';
                document.getElementById('seccion_id').value = seccion.id;
                document.getElementById('seccion_is_new').value = 'false';
                document.getElementById('seccion_nombre').value = seccion.nombre;
                document.getElementById('seccion_icono').value = seccion.icono || 'bi-folder';
                document.getElementById('seccion_color').value = seccion.color || 'gray';
                document.getElementById('seccion_descripcion').value = seccion.descripcion || '';

                // Seleccionar color
                document.querySelectorAll('.color-picker-item').forEach(item => {
                    item.classList.remove('selected');
                    if (item.dataset.color === seccion.color) {
                        item.classList.add('selected');
                    }
                });
            }
        } else {
            // Nueva sección
            titulo.innerHTML = '<i class="bi bi-folder-plus me-2"></i>Nueva Sección';
            document.getElementById('seccion_id').value = '';
            document.getElementById('seccion_is_new').value = 'true';
            document.getElementById('seccion_nombre').value = '';
            document.getElementById('seccion_icono').value = 'bi-folder';
            document.getElementById('seccion_color').value = 'purple';
            document.getElementById('seccion_descripcion').value = '';

            // Resetear color
            document.querySelectorAll('.color-picker-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector('.color-picker-item[data-color="purple"]').classList.add('selected');
        }

        modal.show();
    }

    function editarSeccion(seccionId) {
        mostrarModalSeccion(seccionId);
    }

    function seleccionarColorSeccion(element) {
        document.querySelectorAll('.color-picker-item').forEach(item => {
            item.classList.remove('selected');
        });
        element.classList.add('selected');
        document.getElementById('seccion_color').value = element.dataset.color;
    }

    function guardarSeccion() {
        const isNew = document.getElementById('seccion_is_new').value === 'true';
        const nombre = document.getElementById('seccion_nombre').value.trim();
        const icono = document.getElementById('seccion_icono').value;
        const color = document.getElementById('seccion_color').value;
        const descripcion = document.getElementById('seccion_descripcion').value.trim();

        if (!nombre) {
            alert('El nombre de la sección es requerido');
            return;
        }

        if (isNew) {
            // Crear nueva sección
            const newId = 'seccion_' + Date.now();
            const maxOrden = Math.max(...scoringData.secciones.map(s => s.orden || 0), 0);

            scoringData.secciones.push({
                id: newId,
                nombre: nombre,
                icono: icono,
                color: color,
                descripcion: descripcion,
                orden: maxOrden + 1
            });

            console.log('✅ Nueva sección creada:', newId);
        } else {
            // Editar sección existente
            const seccionId = document.getElementById('seccion_id').value;
            const seccion = scoringData.secciones.find(s => s.id === seccionId);

            if (seccion) {
                seccion.nombre = nombre;
                seccion.icono = icono;
                seccion.color = color;
                seccion.descripcion = descripcion;
                console.log('✅ Sección actualizada:', seccionId);
            }
        }

        // Cerrar modal y actualizar vista
        bootstrap.Modal.getInstance(document.getElementById('seccionModal')).hide();
        updateCriteriosList();
    }

    function eliminarSeccion(seccionId) {
        const seccion = scoringData.secciones.find(s => s.id === seccionId);
        if (!seccion) return;

        document.getElementById('eliminar_seccion_id').value = seccionId;
        document.getElementById('eliminar_seccion_nombre').textContent = seccion.nombre;

        const modal = new bootstrap.Modal(document.getElementById('eliminarSeccionModal'));
        modal.show();
    }

    function confirmarEliminarSeccion() {
        const seccionId = document.getElementById('eliminar_seccion_id').value;

        // Mover criterios de esta sección a "otros"
        Object.keys(scoringData.criterios).forEach(criterioId => {
            if (scoringData.criterios[criterioId].seccion === seccionId) {
                scoringData.criterios[criterioId].seccion = 'otros';
            }
        });

        // Eliminar sección
        scoringData.secciones = scoringData.secciones.filter(s => s.id !== seccionId);

        // Cerrar modal y actualizar
        bootstrap.Modal.getInstance(document.getElementById('eliminarSeccionModal')).hide();
        updateCriteriosList();

        console.log('✅ Sección eliminada:', seccionId);
    }

    function agregarCriterioASeccion(seccionId) {
        // Abrir modal de nuevo criterio con sección preseleccionada
        window.seccionPreseleccionada = seccionId;
        addNewCriterio();
    }

    // ============================================
    // 🎯 DRAG & DROP PARA CRITERIOS (2025-12-26)
    // ============================================

    let draggedCriterioId = null;
    let draggedSeccionId = null;

    function handleDragStart(event, criterioId) {
        event.stopPropagation(); // 2025-12-26: Evitar que burbujee al padre (sección draggable)
        draggedCriterioId = criterioId;
        draggedSeccionId = null;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', criterioId);
        event.dataTransfer.setData('type', 'criterio');

        setTimeout(() => {
            event.target.classList.add('dragging');
        }, 0);

        console.log('🔄 Arrastrando criterio:', criterioId);
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(event) {
        event.preventDefault();
        const target = event.target.closest('.scoring-criteria-row');
        if (target && !target.classList.contains('dragging')) {
            target.classList.add('drag-over');
        }
    }

    function handleDragLeave(event) {
        const target = event.target.closest('.scoring-criteria-row');
        if (target) {
            target.classList.remove('drag-over');
        }
    }

    function handleDrop(event, targetCriterioId) {
        event.preventDefault();
        event.stopPropagation();

        const target = event.target.closest('.scoring-criteria-row');
        if (target) target.classList.remove('drag-over');

        if (!draggedCriterioId || draggedCriterioId === targetCriterioId) return;

        const targetCriterio = scoringData.criterios[targetCriterioId];
        const draggedCriterio = scoringData.criterios[draggedCriterioId];

        if (!targetCriterio || !draggedCriterio) return;

        // Obtener sección destino
        const targetSeccion = targetCriterio.seccion || 'otros';
        const origenSeccion = draggedCriterio.seccion || 'otros';

        // PRIMERO: Mover criterio a la sección destino
        draggedCriterio.seccion = targetSeccion;

        // DESPUÉS: Obtener todos los criterios de la sección destino (ya incluye el movido)
        const criteriosDeSeccion = Object.entries(scoringData.criterios)
            .filter(([id, c]) => (c.seccion || 'otros') === targetSeccion)
            .sort((a, b) => (a[1].orden || 0) - (b[1].orden || 0));

        // Encontrar índices
        const draggedIndex = criteriosDeSeccion.findIndex(([id]) => id === draggedCriterioId);
        const targetIndex = criteriosDeSeccion.findIndex(([id]) => id === targetCriterioId);

        console.log('🔍 Reordenando:', {draggedIndex, targetIndex, total: criteriosDeSeccion.length});

        if (draggedIndex !== -1 && targetIndex !== -1 && draggedIndex !== targetIndex) {
            // Remover de posición actual
            const [moved] = criteriosDeSeccion.splice(draggedIndex, 1);

            // Calcular nueva posición (ajustar si viene de arriba)
            const insertIndex = draggedIndex < targetIndex ? targetIndex : targetIndex;
            criteriosDeSeccion.splice(insertIndex, 0, moved);

            // Actualizar orden de TODOS los criterios en la sección
            criteriosDeSeccion.forEach(([id, criterio], index) => {
                scoringData.criterios[id].orden = index;
            });
        }

        updateCriteriosList();
        console.log('✅ Criterio movido:', draggedCriterioId, '→', targetCriterioId, '(sección:', targetSeccion, ')');
    }

    function handleDragEnd(event) {
        event.target.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        document.querySelectorAll('.drag-over-seccion').forEach(el => el.classList.remove('drag-over-seccion'));
        draggedCriterioId = null;
    }

    // Drag & drop para soltar en body de sección (mover criterio a otra sección)
    function handleCriterioDragOverBody(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }

    function handleCriterioDragEnterBody(event, seccionId) {
        event.preventDefault();
        if (draggedCriterioId) {
            const body = document.getElementById(`body-${seccionId}`);
            if (body) body.classList.add('drag-over');
        }
    }

    function handleCriterioDragLeaveBody(event) {
        const body = event.target.closest('.criterios-seccion-body');
        if (body && !body.contains(event.relatedTarget)) {
            body.classList.remove('drag-over');
        }
    }

    function handleCriterioDropInSeccion(event, seccionId) {
        event.preventDefault();
        event.stopPropagation();

        console.log('📥 DROP en sección:', seccionId, 'criterio:', draggedCriterioId); // DEBUG

        const body = document.getElementById(`body-${seccionId}`);
        if (body) body.classList.remove('drag-over');

        if (!draggedCriterioId) {
            console.log('⚠️ No hay criterio arrastrado');
            return;
        }

        const criterio = scoringData.criterios[draggedCriterioId];
        if (!criterio) {
            console.log('⚠️ Criterio no encontrado:', draggedCriterioId);
            return;
        }

        const seccionAnterior = criterio.seccion || 'otros';

        // Mover criterio a la nueva sección
        criterio.seccion = seccionId;

        // Poner al final de la sección
        const criteriosDeSeccion = Object.entries(scoringData.criterios)
            .filter(([id, c]) => (c.seccion || 'otros') === seccionId);
        criterio.orden = criteriosDeSeccion.length;

        updateCriteriosList();
        console.log('✅ Criterio movido a sección:', draggedCriterioId, seccionAnterior, '→', seccionId);
    }

    // ============================================
    // 🎯 DRAG & DROP PARA SECCIONES
    // ============================================

    function handleSeccionDragStart(event, seccionId) {
        // Solo permitir arrastrar si se hace click en el header
        const header = event.target.closest('.criterios-seccion-header');
        if (!header) {
            event.preventDefault();
            return;
        }

        draggedSeccionId = seccionId;
        draggedCriterioId = null;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', seccionId);
        event.dataTransfer.setData('type', 'seccion');

        setTimeout(() => {
            event.target.classList.add('dragging');
        }, 0);

        console.log('🔄 Arrastrando sección:', seccionId);
    }

    function handleSeccionDragOver(event) {
        event.preventDefault();
        if (draggedSeccionId) {
            event.dataTransfer.dropEffect = 'move';
            const target = event.target.closest('.criterios-seccion');
            if (target && !target.classList.contains('dragging')) {
                target.classList.add('drag-over-seccion');
            }
        }
    }

    function handleSeccionDrop(event, targetSeccionId) {
        event.preventDefault();

        const target = event.target.closest('.criterios-seccion');
        if (target) target.classList.remove('drag-over-seccion');

        if (!draggedSeccionId || draggedSeccionId === targetSeccionId) return;

        // Reordenar secciones
        const draggedIndex = scoringData.secciones.findIndex(s => s.id === draggedSeccionId);
        const targetIndex = scoringData.secciones.findIndex(s => s.id === targetSeccionId);

        if (draggedIndex !== -1 && targetIndex !== -1) {
            const [moved] = scoringData.secciones.splice(draggedIndex, 1);
            scoringData.secciones.splice(targetIndex, 0, moved);

            // Actualizar orden
            scoringData.secciones.forEach((seccion, index) => {
                seccion.orden = index;
            });
        }

        updateCriteriosList();
        console.log('✅ Sección movida:', draggedSeccionId, '→', targetSeccionId);
    }

    function handleSeccionDragEnd(event) {
        event.target.classList.remove('dragging');
        document.querySelectorAll('.drag-over-seccion').forEach(el => el.classList.remove('drag-over-seccion'));
        draggedSeccionId = null;
    }

    // ============================================
    // 🔼🔽 MOVER SECCIONES ARRIBA/ABAJO (2025-12-26)
    // ============================================

    function moverSeccionArriba(seccionId) {
        const index = scoringData.secciones.findIndex(s => s.id === seccionId);
        if (index <= 0) {
            console.log('⚠️ Sección ya está en la primera posición');
            return;
        }

        // Intercambiar con la sección anterior
        const temp = scoringData.secciones[index];
        scoringData.secciones[index] = scoringData.secciones[index - 1];
        scoringData.secciones[index - 1] = temp;

        // Actualizar orden
        scoringData.secciones.forEach((seccion, i) => {
            seccion.orden = i;
        });

        updateCriteriosList();
        console.log('⬆️ Sección movida arriba:', seccionId);
    }

    function moverSeccionAbajo(seccionId) {
        const index = scoringData.secciones.findIndex(s => s.id === seccionId);
        if (index === -1 || index >= scoringData.secciones.length - 1) {
            console.log('⚠️ Sección ya está en la última posición');
            return;
        }

        // Intercambiar con la sección siguiente
        const temp = scoringData.secciones[index];
        scoringData.secciones[index] = scoringData.secciones[index + 1];
        scoringData.secciones[index + 1] = temp;

        // Actualizar orden
        scoringData.secciones.forEach((seccion, i) => {
            seccion.orden = i;
        });

        updateCriteriosList();
        console.log('⬇️ Sección movida abajo:', seccionId);
    }

    // ============================================
    // 🎯 SOPORTE TÁCTIL PARA MÓVILES (2025-12-26)
    // ============================================

    let touchStartY = 0;
    let touchCurrentY = 0;
    let touchedElement = null;
    let touchedCriterioId = null;
    let touchClone = null;

    function handleTouchStart(event, criterioId) {
        const target = event.target.closest('.drag-handle');
        if (!target) return;

        event.preventDefault();

        touchedCriterioId = criterioId;
        touchedElement = event.target.closest('.scoring-criteria-row');
        touchStartY = event.touches[0].clientY;

        // Crear clon visual
        touchClone = touchedElement.cloneNode(true);
        touchClone.style.position = 'fixed';
        touchClone.style.top = touchedElement.getBoundingClientRect().top + 'px';
        touchClone.style.left = touchedElement.getBoundingClientRect().left + 'px';
        touchClone.style.width = touchedElement.offsetWidth + 'px';
        touchClone.style.opacity = '0.8';
        touchClone.style.zIndex = '9999';
        touchClone.style.pointerEvents = 'none';
        touchClone.classList.add('dragging');
        document.body.appendChild(touchClone);

        touchedElement.style.opacity = '0.3';

        console.log('📱 Touch start:', criterioId);
    }

    function handleTouchMove(event) {
        if (!touchedElement || !touchClone) return;

        event.preventDefault();

        touchCurrentY = event.touches[0].clientY;
        const deltaY = touchCurrentY - touchStartY;

        const originalTop = touchedElement.getBoundingClientRect().top;
        touchClone.style.top = (originalTop + deltaY) + 'px';

        const elementsAtPoint = document.elementsFromPoint(
            event.touches[0].clientX,
            event.touches[0].clientY
        );

        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

        for (const el of elementsAtPoint) {
            const criterioRow = el.closest('.scoring-criteria-row');
            if (criterioRow && criterioRow !== touchedElement) {
                criterioRow.classList.add('drag-over');
                break;
            }
        }
    }

    function handleTouchEnd(event) {
        if (!touchedElement || !touchClone) return;

        const elementsAtPoint = document.elementsFromPoint(
            event.changedTouches[0].clientX,
            event.changedTouches[0].clientY
        );

        let targetCriterioId = null;
        let targetSeccionId = null;

        for (const el of elementsAtPoint) {
            const criterioRow = el.closest('.scoring-criteria-row');
            if (criterioRow && criterioRow !== touchedElement) {
                targetCriterioId = criterioRow.dataset.criterioId;
                break;
            }
            const seccionBody = el.closest('.criterios-seccion-body');
            if (seccionBody) {
                targetSeccionId = seccionBody.id.replace('body-', '');
            }
        }

        // Limpiar
        if (touchClone) {
            touchClone.remove();
            touchClone = null;
        }

        if (touchedElement) {
            touchedElement.style.opacity = '1';
        }

        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

        // Reordenar
        if (targetCriterioId && touchedCriterioId && targetCriterioId !== touchedCriterioId) {
            draggedCriterioId = touchedCriterioId;
            handleDrop({ preventDefault: () => {}, stopPropagation: () => {}, target: document.getElementById(`criterio-${targetCriterioId}`) }, targetCriterioId);
        } else if (targetSeccionId && touchedCriterioId) {
            const criterio = scoringData.criterios[touchedCriterioId];
            if (criterio) {
                criterio.seccion = targetSeccionId;
                updateCriteriosList();
                console.log('📱 Touch: criterio movido a sección:', touchedCriterioId, '→', targetSeccionId);
            }
        }

        touchedElement = null;
        touchedCriterioId = null;
    }

    // Editar rango individual
    function editRango(criterioId, rangoIndex) {
        if (!window.scoringData || !window.scoringData.criterios) {
            console.error('❌ scoringData no disponible');
            return;
        }

        const criterio = window.scoringData.criterios[criterioId];
        if (!criterio || !criterio.rangos || !criterio.rangos[rangoIndex]) {
            console.error('❌ Rango no encontrado:', criterioId, rangoIndex);
            return;
        }

        const rango = criterio.rangos[rangoIndex];

        // Abrir modal de edición con datos del criterio
        editCriterio(criterioId);

        // Después de un pequeño delay, hacer scroll al rango específico y resaltarlo
        setTimeout(() => {
            const rangoElement = document.querySelector(`#rangos_container .rango-row:nth-child(${rangoIndex + 1})`);
            if (rangoElement) {
                rangoElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                rangoElement.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    rangoElement.style.backgroundColor = '';
                }, 2000);
            }
        }, 300);
    }

    function deleteRango(criterioId, rangoIndex) {
    // Confirmación antes de eliminar
    if (!confirm('¿Está seguro de eliminar este rango?')) {
        return;
    }

    const criterio = scoringData.criterios[criterioId];

    // Validar que el criterio existe
    if (!criterio) {
        alert('Error: Criterio no encontrado');
        return;
    }

    // Validar que tiene rangos
    if (!criterio.rangos || !Array.isArray(criterio.rangos)) {
        alert('Error: Este criterio no tiene rangos configurados');
        return;
    }

    // Validar que el índice es válido
    if (rangoIndex < 0 || rangoIndex >= criterio.rangos.length) {
        alert('Error: Rango no encontrado');
        return;
    }

    // Eliminar el rango
    criterio.rangos.splice(rangoIndex, 1);

    console.log(`🗑️ Rango ${rangoIndex} eliminado del criterio ${criterioId}`);

    // Actualizar la lista en pantalla
    updateCriteriosList();

    // Notificar al usuario
    alert('Rango eliminado correctamente. Recuerde guardar la configuración.');
}

    function addRango(criterioId) {
        editCriterio(criterioId);
        addRangoToForm();
    }

    // NOTA: Las funciones moveCriterioUp/Down y handleDragStart/End
    // fueron movidas a la sección de SISTEMA DE SECCIONES Y CRITERIOS

    // ============================================
    // 🎯 SECCIÓN 5: GESTIÓN DE COSTOS
    // ============================================

    var costosCounter = {};

    function agregarCosto(tipoCredito) {
        const container = document.getElementById('costos-container-' + tipoCredito);
        const index = costosCounter[tipoCredito];
        costosCounter[tipoCredito]++;

        const nuevoCosto = document.createElement('div');
        nuevoCosto.className = 'mb-3 costo-row';
        nuevoCosto.innerHTML = `
            <div class="input-group">
                <span class="input-group-text">Costo</span>
                <input type="text" class="form-control nombre-costo"
                       placeholder="Nombre del costo" name="nombre_costo_${index}" required>
                <span class="input-group-text">$</span>
                <input type="text" name="valor_costo_${index}" placeholder="0"
                       class="form-control valor-costo" oninput="formatNumber(this)" required>
                <button type="button" class="btn btn-outline-danger" onclick="eliminarCosto(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(nuevoCosto);
    }

    // Función para eliminar un costo
    function eliminarCosto(boton) {
        if (confirm('¿Está seguro de eliminar este costo?')) {
            const costoRow = boton.closest('.costo-row');
            costoRow.remove();

            // Reordenar índices - con validación null-safe
            const form = boton.closest('form');
            const tipoCreditoInput = form ? form.querySelector('input[name="tipo_credito"]') : null;
            if (tipoCreditoInput) {
                renumerarCostos(tipoCreditoInput.value);
            }
        }
    }

    // Función para renumerar los índices de los costos después de eliminar
    function renumerarCostos(tipoCredito) {
        const container = document.getElementById('costos-container-' + tipoCredito);
        const costoRows = container.querySelectorAll('.costo-row');
        costoRows.forEach((row, index) => {
            const nombreInput = row.querySelector('.nombre-costo');
            const valorInput = row.querySelector('.valor-costo');
            nombreInput.name = 'nombre_costo_' + index;
            valorInput.name = 'valor_costo_' + index;
        });
        costosCounter[tipoCredito] = costoRows.length;
    }

    // ============================================
    // 🎯 SECCIÓN 6: GESTIÓN DE LÍNEAS DE CRÉDITO
    // ============================================

    function actualizarTasaMensualNueva() {
        const tasaAnualInput = document.getElementById('nueva_tasa_anual');
        const tasaMensualSpan = document.getElementById('nueva_tasa_mensual_mostrar');
        const tasaAnual = tasaAnualInput.value.replace(',', '.');

        if (!isNaN(tasaAnual) && tasaAnual.trim() !== '') {
            const tasaMensual = calcularTasaMensual(tasaAnual);
            tasaMensualSpan.innerText = tasaMensual + '%';
        } else {
            tasaMensualSpan.innerText = 'Error';
        }
    }

    function eliminarLineaCredito(nombreLinea) {
        document.getElementById('eliminar_linea_nombre').textContent = nombreLinea;
        document.getElementById('eliminar_linea_id').value = nombreLinea;
        const modal = new bootstrap.Modal(document.getElementById('eliminarLineaCreditoModal'));
        modal.show();
    }

    function confirmarEliminacionLinea() {
        const nombreLinea = document.getElementById('eliminar_linea_id').value;
        const csrfToken = getCSRFToken();
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/lineas/eliminar';

        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'csrf_token';
        tokenInput.value = csrfToken;
        form.appendChild(tokenInput);

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'nombre_linea';
        input.value = nombreLinea;
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
    }

    function inicializarAvalPorDefecto() {
        if (!scoringData.niveles_riesgo) return;

        scoringData.niveles_riesgo.forEach((nivel, nivelIndex) => {
            if (!nivel.aval_por_producto) {
                nivel.aval_por_producto = {};

                Object.keys({{ lineas_credito|safe }}).forEach(tipoCredito => {
                    let avalDefecto = {{ lineas_credito|safe }}[tipoCredito].aval_porcentaje;

                    if (nivel.nombre === "Alto riesgo") {
                        avalDefecto = avalDefecto * 1.5;
                    } else if (nivel.nombre === "Riesgo moderado") {
                        avalDefecto = avalDefecto * 1.2;
                    } else if (nivel.nombre === "Bajo riesgo") {
                        avalDefecto = avalDefecto * 0.8;
                    }

                    nivel.aval_por_producto[tipoCredito] = Math.min(avalDefecto, 0.25);
                });
            }
        });
    }

    // ============================================
    // 🎯 SECCIÓN 7: INICIALIZACIÓN GLOBAL
    // ============================================

    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Inicializando aplicación admin...');

        // 7.1 Inicializar sistema de tabs
        initializeTabs();

        // 7.2 Inicializar contadores de costos
        {% for tipo_credito, costos in costos_asociados.items() %}
        costosCounter['{{ tipo_credito }}'] = {{ costos|length }};
        {% endfor %}

        // 7.3 Inicializar tasas mensuales
        {% for tipo_credito, datos in lineas_credito.items() %}
        actualizarTasaMensual('tasa_anual_{{ tipo_credito }}', 'tasa_mensual_{{ tipo_credito }}');
        {% endfor %}

        // 7.4 Agregar listeners a formularios
        var forms = document.querySelectorAll('form[method="post"]');
        forms.forEach(function(form) {
            form.addEventListener('submit', saveCurrentTab);
        });

        // 7.5 Modal de cambiar contraseña
        var cambiarPasswordModal = document.getElementById('cambiarPasswordModal');
        if (cambiarPasswordModal) {
            cambiarPasswordModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var username = button.getAttribute('data-username');
                document.getElementById('modalUsername').value = username;
            });
        }

        // 7.6 Inicializar aval por defecto
        inicializarAvalPorDefecto();

        // 7.7 Listener para cargar parámetros de capacidad al abrir tab
        const capacidadTabButton = document.querySelector('button[onclick*="CapacidadPago"]');
        if (capacidadTabButton) {
            capacidadTabButton.addEventListener('click', function() {
                setTimeout(() => {
                    cargarParametrosCapacidad();
                }, 100);
            });
        }

        // =====================================================
        // 7.8 INICIALIZAR SECCIONES Y CRITERIOS (2025-12-26)
        // =====================================================

        // CRÍTICO: Asignar 'seccion' por defecto a criterios que no la tienen
        if (window.scoringData && window.scoringData.criterios) {
            let criteriosSinSeccion = 0;
            Object.keys(window.scoringData.criterios).forEach(criterioId => {
                if (!window.scoringData.criterios[criterioId].seccion) {
                    window.scoringData.criterios[criterioId].seccion = 'otros';
                    criteriosSinSeccion++;
                }
            });
            if (criteriosSinSeccion > 0) {
                console.log(`✅ Asignada sección 'otros' a ${criteriosSinSeccion} criterios`);
            }
        }

        // Listener para renderizar secciones cuando se muestra el sub-tab de criterios
        const criteriosTab = document.getElementById('criterios-tab');
        if (criteriosTab) {
            criteriosTab.addEventListener('shown.bs.tab', function() {
                console.log('📋 Sub-tab Criterios activado, renderizando secciones...');
                if (typeof updateCriteriosList === 'function') {
                    updateCriteriosList();
                }
            });

            // Si el sub-tab ya está activo al cargar (por sessionStorage), renderizar
            const criteriosContent = document.getElementById('criterios-content');
            if (criteriosContent && criteriosContent.classList.contains('show')) {
                setTimeout(() => {
                    console.log('📋 Sub-tab Criterios ya activo, renderizando...');
                    if (typeof updateCriteriosList === 'function') {
                        updateCriteriosList();
                    }
                }, 200);
            }
        }

        // Restaurar sub-tab activo después de guardar (mejorado 2025-12-26)
        const savedSubTab = sessionStorage.getItem('scoringActiveSubTab');
        if (savedSubTab && window.location.hash.includes('Scoring')) {
            setTimeout(() => {
                const subTabButton = document.querySelector(`[data-bs-target="${savedSubTab}"]`);
                if (subTabButton) {
                    const tab = new bootstrap.Tab(subTabButton);
                    tab.show();
                    console.log('✅ Sub-tab restaurado:', savedSubTab);
                }
                sessionStorage.removeItem('scoringActiveSubTab');
            }, 500); // Aumentado timeout para asegurar que los tabs estén listos
        }

        console.log('✅ Aplicación admin inicializada correctamente');
    });
</script>
</div>

<script>
// ============================================
// SECCIÓN 8: GESTIÓN DE CAPACIDAD DE PAGO
// ============================================

async function cargarParametrosCapacidad() {
    try {
        const response = await fetch('/api/capacidad-config');
        if (response.ok) {
            const parametros = await response.json();

            const limiteConservador = document.getElementById('limite_conservador');
            const limiteMaximo = document.getElementById('limite_maximo');
            const limiteAbsoluto = document.getElementById('limite_absoluto');
            const descripcionConservador = document.getElementById('descripcion_conservador');
            const descripcionMaximo = document.getElementById('descripcion_maximo');
            const descripcionAbsoluto = document.getElementById('descripcion_absoluto');
            const notasCapacidad = document.getElementById('notas_capacidad');

            if (limiteConservador) limiteConservador.value = parametros.limite_conservador || 30;
            if (limiteMaximo) limiteMaximo.value = parametros.limite_maximo || 35;
            if (limiteAbsoluto) limiteAbsoluto.value = parametros.limite_absoluto || 40;
            if (descripcionConservador) descripcionConservador.value = parametros.descripcion_conservador || '';
            if (descripcionMaximo) descripcionMaximo.value = parametros.descripcion_maximo || '';
            if (descripcionAbsoluto) descripcionAbsoluto.value = parametros.descripcion_absoluto || '';
            if (notasCapacidad) notasCapacidad.value = parametros.notas || '';

            console.log('✅ Parámetros de capacidad cargados en admin');
        }
    } catch (error) {
        console.error('❌ Error al cargar parámetros:', error);
    }
}

async function guardarParametrosCapacidad() {
    const btnGuardar = event.target;
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    btnGuardar.disabled = true;

    try {
        // Obtener valores
        const limiteConservador = parseInt(document.getElementById('limite_conservador').value);
        const limiteMaximo = parseInt(document.getElementById('limite_maximo').value);
        const limiteAbsoluto = parseInt(document.getElementById('limite_absoluto').value);

        // Validar orden
        if (limiteConservador > limiteMaximo || limiteMaximo > limiteAbsoluto) {
            alert('❌ Error: Los límites deben estar en orden: Conservador ≤ Máximo ≤ Absoluto');
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
            return;
        }

        // Validar rangos
        if (limiteConservador < 10 || limiteConservador > 50) {
            alert('❌ Error: Límite conservador debe estar entre 10% y 50%');
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
            return;
        }

        if (limiteAbsoluto > 60) {
            if (!confirm('⚠️ Advertencia: Límite absoluto superior a 60% puede causar sobreendeudamiento. ¿Está seguro?')) {
                btnGuardar.innerHTML = textoOriginal;
                btnGuardar.disabled = false;
                return;
            }
        }

        // Preparar datos
        const datos = {
            limite_conservador: limiteConservador,
            limite_maximo: limiteMaximo,
            limite_absoluto: limiteAbsoluto,
            descripcion_conservador: document.getElementById('descripcion_conservador').value,
            descripcion_maximo: document.getElementById('descripcion_maximo').value,
            descripcion_absoluto: document.getElementById('descripcion_absoluto').value,
            notas: document.getElementById('notas_capacidad').value
        };

        // Obtener CSRF token
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            alert('❌ Error: Token CSRF no encontrado');
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
            return;
        }

        // Enviar al servidor
        const response = await fetch('/admin/capacidad/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(datos)
        });

        const result = await response.json();

        if (result.success) {
            alert('✅ Parámetros guardados correctamente');
            console.log('✅ Parámetros de capacidad actualizados:', datos);
        } else {
            alert('❌ Error: ' + result.error);
        }

    } catch (error) {
        console.error('❌ Error al guardar:', error);
        alert('❌ Error de conexión: ' + error.message);
    } finally {
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
    }
}
</script>

<script>
// Forzar 2 decimales en todos los inputs de aval
document.addEventListener('DOMContentLoaded', function() {
    const avalInputs = document.querySelectorAll('.nivel-aval-input');

    avalInputs.forEach(input => {
        // Formatear valor inicial
        if (input.value) {
            input.value = parseFloat(input.value).toFixed(2);
        }

        // Limitar a 2 decimales al escribir
        input.addEventListener('input', function() {
            let value = this.value;

            // Permitir punto decimal y números
            if (!/^\d*\.?\d{0,2}$/.test(value)) {
                this.value = value.slice(0, -1);
            }
        });

        // Formatear al perder foco
        input.addEventListener('blur', function() {
            if (this.value) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    });
});
</script>

<!-- Restaurar sub-tab de Scoring activo después de reload (2025-12-26 mejorado) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const savedSubTab = sessionStorage.getItem('scoringActiveSubTab');
    if (savedSubTab && window.location.hash.includes('Scoring')) {
        setTimeout(() => {
            const tabTrigger = document.querySelector(`[data-bs-target="${savedSubTab}"]`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
                console.log('✅ Sub-tab Scoring restaurado (script 2):', savedSubTab);
            }
            sessionStorage.removeItem('scoringActiveSubTab');
        }, 600); // Ligeramente más tarde que el otro script
    }
});
</script>

<!-- Script CSRF para todos los formularios del admin -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener todos los formularios con method="post"
    const forms = document.querySelectorAll('form[method="post"], form[method="POST"]');

    forms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.innerHTML : '';

            // Deshabilitar botón durante petición
            if (submitBtn) {
                submitBtn.disabled = true;
                if (submitBtn.innerHTML.includes('Guardar') || submitBtn.innerHTML.includes('Crear')) {
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
                }
            }

            try {
                // Obtener token fresco
                const response = await fetch('/api/csrf-token');
                const data = await response.json();

                // Actualizar token
                const csrfInput = this.querySelector('input[name="csrf_token"]');
                if (csrfInput && data.csrf_token) {
                    csrfInput.value = data.csrf_token;
                }

                // Enviar formulario
                this.submit();
            } catch (error) {
                console.error('Error obteniendo CSRF token:', error);
                // Restaurar botón si falla
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
                // Intentar enviar de todos modos
                this.submit();
            }
        });
    });
});
</script>
<script src="/static/js/theme-unified.js"></script>

<script>
  // Selecciona el modal por su ID
  const modalDetalle = document.getElementById('modalDetalle');

  if (modalDetalle) {
    modalDetalle.addEventListener('hidden.bs.modal', function () {
      // Elimina backdrop residual
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    });
  }
</script>

<script>
// Protección adicional: si se navega directamente al tab Permisos sin permiso
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si hay una variable de permiso disponible (agregar en el template si es necesario)
    const tienePermisoPermisos = {{ 'true' if tiene_permiso('usr_permisos') else 'false' }};

    // Si el hash es #Permisos y no tiene permiso
    if (window.location.hash === '#Permisos' && !tienePermisoPermisos) {
        // Redirigir al tab por defecto
        window.location.hash = '#Usuarios';

        // Mostrar alerta
        setTimeout(function() {
            alert('No tienes permiso para acceder a la gestión de permisos.');
        }, 100);
    }

    // Interceptar clicks en el tab Permisos (por si se manipula el DOM)
    if (!tienePermisoPermisos) {
        document.addEventListener('click', function(e) {
            if (e.target && e.target.textContent && e.target.textContent.includes('Permisos')) {
                if (e.target.classList.contains('tablinks')) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('No tienes permiso para acceder a la gestión de permisos.');
                    return false;
                }
            }
        }, true);
    }
});
</script>

</body>
</html>